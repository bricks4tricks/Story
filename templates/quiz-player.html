<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logic and Stories | Quiz</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="/static/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/favicon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/favicon-512x512.png">
    <link rel="apple-touch-icon" href="/static/apple-touch-icon.png">
    
    <link href="/static/css/styles.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
        .font-pacifico { font-family: 'Pacifico', cursive; }
        .gradient-text { background: linear-gradient(to right, #fde047, #fb923c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .solution-area {
            transition: all 0.3s ease-in-out;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transform: translateY(10px);
        }
        .solution-area.visible {
            max-height: 500px; /* Adjust based on expected content height */
            opacity: 1;
            transform: translateY(0);
        }
        /* Modal styles */
        .modal-hidden { display: none !important; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-slate-900 text-gray-200 flex flex-col min-h-screen">

    <script>
        // Basic authentication check
        if (!localStorage.getItem('userId')) { window.location.href = '/'; }
    </script>

    <header class="bg-slate-800 border-b border-slate-700">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/" class="text-3xl font-pacifico gradient-text pb-1 leading-normal">Logic and Stories</a>
            <button id="mobile-menu-toggle" class="md:hidden text-gray-200 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <div class="hidden md:flex items-center space-x-4">
                <a href="/dashboard.html" class="bg-gray-600 text-white font-bold py-2 px-5 rounded-full hover:bg-gray-500">Exit to Dashboard</a>
            </div>
        </nav>
        <div id="mobile-menu" class="md:hidden hidden px-6 pb-4">
            <a href="/dashboard.html" class="block py-2 hover:text-yellow-400">Exit to Dashboard</a>
        </div>
    </header>

    <main id="quiz-container" class="container mx-auto px-6 py-12 flex-grow flex flex-col justify-center items-center">
        <div id="loader" class="text-center">
            <h2 class="text-2xl font-bold">Loading your quiz question...</h2>
        </div>

        <div id="quiz-content" class="w-full max-w-3xl hidden">
            <h2 class="text-3xl font-bold text-center mb-6 text-yellow-400">Quiz Time!</h2>

            <div class="bg-slate-800 p-8 rounded-2xl border border-slate-700">
                <div class="flex justify-between items-start mb-4">
                    <p class="text-xl font-bold text-white pr-4" id="question-text"></p>
                    <div class="flex-shrink-0">
                        <button id="flag-question-btn" class="text-gray-400 hover:text-red-400 text-sm flex items-center space-x-1" title="Flag this question for review">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9m0 3.5V12"></path></svg>
                            <span>Flag</span>
                        </button>
                    </div>
                </div>

                <div id="answers-container" class="space-y-3 mb-6">
                    <!-- Answers will be loaded here -->
                </div>

                <div id="user-feedback" class="text-center mb-4 h-6 text-xl font-semibold"></div>

                <button id="submit-answer-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-full w-full hover:bg-blue-500">Submit Answer</button>
            </div>

            <div id="solution-area" class="mt-4 bg-slate-700 border border-slate-600 p-6 rounded-lg solution-area">
                <p id="correct-answer-display" class="font-bold mb-4"></p>
                <h3 class="font-bold text-gray-300 mb-2">Solution Steps:</h3>
                <ol id="solution-steps" class="list-decimal list-inside text-gray-200 space-y-2"></ol>
            </div>

            <div id="navigation-area" class="mt-8 text-center space-x-4">
                <button id="next-question-btn" class="bg-yellow-400 text-slate-900 font-bold py-3 px-12 rounded-full text-lg hover:bg-yellow-300" disabled>Next Question</button>
                <button id="back-to-dashboard-btn" class="bg-gray-600 text-white font-bold py-3 px-8 rounded-full text-lg hover:bg-gray-500">Back to Dashboard</button>
            </div>
        </div>

        <div id="error-display" class="text-center text-red-400 hidden"></div>
    </main>

    <div id="flag-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center opacity-0">
        <div class="modal-content bg-slate-800 rounded-2xl p-8 max-w-md w-full mx-4 relative scale-95">
            <button id="close-flag-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white mb-4">Report Issue</h2>
            <textarea id="flag-reason" class="w-full h-32 bg-slate-700 text-gray-200 p-2 rounded-md mb-4" placeholder="Describe the issue (optional)"></textarea>
            <button id="submit-flag-btn" class="bg-yellow-400 text-slate-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-300 w-full">Submit</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            if (mobileMenuToggle && mobileMenu) {
                mobileMenuToggle.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }

            const userId = localStorage.getItem('userId');
            const urlParams = new URLSearchParams(window.location.search);
            const topicId = urlParams.get('topicId');

            if (!topicId) {
                document.getElementById('loader').innerHTML = `<h2 class="text-2xl font-bold text-red-500">Error: No Topic ID provided.</h2><a href="/dashboard.html" class="text-yellow-400 hover:underline">Return to Dashboard</a>`;
                return;
            }

            // --- DOM Elements ---
            const loader = document.getElementById('loader');
            const quizContent = document.getElementById('quiz-content');
            const errorDisplay = document.getElementById('error-display');
            const questionTextElem = document.getElementById('question-text');
            const answersContainer = document.getElementById('answers-container');
            const userFeedbackElem = document.getElementById('user-feedback');
            const submitAnswerBtn = document.getElementById('submit-answer-btn');
            const solutionArea = document.getElementById('solution-area');
            const solutionStepsElem = document.getElementById('solution-steps');
            const correctAnswerDisplay = document.getElementById('correct-answer-display');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const backToDashboardBtn = document.getElementById('back-to-dashboard-btn');
            const flagQuestionBtn = document.getElementById('flag-question-btn');

            let currentQuestionData = null;
            let currentDifficulty = 1; // Default starting difficulty

            // Constants for difficulty adjustment
            const MAX_DIFFICULTY = 5;
            const MIN_DIFFICULTY = 1;

            async function fetchUserDifficulty() {
                try {
                    const response = await fetch(`/api/user/topic-difficulty/${userId}/${topicId}`);
                    if (response.ok) {
                        const result = await response.json();
                        currentDifficulty = result.difficulty;
                    } else {
                        console.warn("Failed to fetch user difficulty, defaulting to 1.");
                        currentDifficulty = 1;
                    }
                } catch (error) {
                    console.error("Error fetching user difficulty:", error);
                    currentDifficulty = 1; // Fallback
                }
            }

            async function fetchQuestion() {
                loader.classList.remove('hidden');
                quizContent.classList.add('hidden');
                solutionArea.classList.remove('visible'); // Hide solution area
                userFeedbackElem.textContent = ''; // Clear feedback
                submitAnswerBtn.disabled = false;
                submitAnswerBtn.textContent = 'Submit Answer';
                nextQuestionBtn.disabled = true;
                flagQuestionBtn.classList.remove('hidden'); // Ensure flag button is visible for new question
                flagQuestionBtn.disabled = false; // Enable flag button
                flagQuestionBtn.textContent = 'Flag'; // Reset text

                await fetchUserDifficulty(); // Get the latest difficulty before fetching question

                try {
                    const response = await fetch(`/api/quiz/question/${userId}/${topicId}/${currentDifficulty}`);
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.message || 'Could not fetch quiz question.');
                    }
                    const result = await response.json();
                    currentQuestionData = result.question;

                    renderQuestion();

                    loader.classList.add('hidden');
                    quizContent.classList.remove('hidden');
                } catch (error) {
                    loader.classList.add('hidden');
                    errorDisplay.classList.remove('hidden');
                    errorDisplay.innerHTML = `<h2>Error: ${error.message}</h2><a href="/dashboard.html" class="text-yellow-400 hover:underline">Return to Dashboard</a>`;
                }
            }

            function renderQuestion() {
                if (!currentQuestionData) return;

                questionTextElem.textContent = currentQuestionData.text;
                answersContainer.innerHTML = '';
                solutionStepsElem.innerHTML = '';
                correctAnswerDisplay.textContent = '';

                if (currentQuestionData.type === 'MultipleChoice' && Array.isArray(currentQuestionData.answers)) {
                    currentQuestionData.answers.forEach(ans => {
                        const label = document.createElement('label');
                        label.className = 'block bg-slate-700/50 p-3 rounded-lg hover:bg-slate-700 cursor-pointer';
                        label.innerHTML = `<input type="radio" name="quiz-answer" value="${ans.AnswerName}" class="mr-3"> ${ans.AnswerName}`;
                        answersContainer.appendChild(label);
                    });
                } else if (currentQuestionData.type === 'OpenEnded') {
                    answersContainer.innerHTML = `<input type="text" id="open-ended-input" class="w-full bg-slate-700 border border-slate-600 rounded-lg p-3 text-white" placeholder="Type your answer here...">`;
                }

                if (Array.isArray(currentQuestionData.steps)) {
                    currentQuestionData.steps.forEach(step => {
                        const li = document.createElement('li');
                        li.textContent = step;
                        solutionStepsElem.appendChild(li);
                    });
                }
            }

            async function handleSubmitAnswer() {
                let userAnswer = '';
                let isCorrectAnswer = false;
                let actualCorrectAnswer = '';

                if (currentQuestionData.type === 'MultipleChoice') {
                    const selected = answersContainer.querySelector('input[name="quiz-answer"]:checked');
                    if (!selected) {
                        userFeedbackElem.textContent = 'Please select an answer.';
                        userFeedbackElem.className = 'text-center text-red-400 mb-4 h-6 text-xl font-semibold';
                        return;
                    }
                    userAnswer = selected.value.trim(); // Trim user input
                    const correctAnsObj = currentQuestionData.answers.find(a => a.IsCorrect === true);
                    if (correctAnsObj) {
                        actualCorrectAnswer = correctAnsObj.AnswerName.trim(); // Trim correct answer from data
                        isCorrectAnswer = (userAnswer.toLowerCase() === actualCorrectAnswer.toLowerCase());
                    }
                } else if (currentQuestionData.type === 'OpenEnded') {
                    const input = answersContainer.querySelector('#open-ended-input');
                    if (!input || !input.value.trim()) {
                        userFeedbackElem.textContent = 'Please type your answer.';
                        userFeedbackElem.className = 'text-center text-red-400 mb-4 h-6 text-xl font-semibold';
                        return;
                    }
                    userAnswer = input.value.trim();
                    const correctAnsObj = currentQuestionData.answers.find(a => a.IsCorrect === true);
                    if (correctAnsObj) {
                        actualCorrectAnswer = correctAnsObj.AnswerName.trim(); // Trim correct answer from data
                        isCorrectAnswer = (userAnswer.toLowerCase() === actualCorrectAnswer.toLowerCase());
                    }
                }

                // Display feedback
                if (isCorrectAnswer) {
                    userFeedbackElem.textContent = 'Correct! 🙂';
                    userFeedbackElem.className = 'text-center text-green-400 mb-4 h-6 text-xl font-semibold';
                    updateDifficulty(true); // Increase difficulty
                } else {
                    userFeedbackElem.textContent = 'Incorrect. 😟';
                    userFeedbackElem.className = 'text-center text-red-400 mb-4 h-6 text-xl font-semibold';
                    updateDifficulty(false); // Decrease difficulty
                }

                // Record the attempt
                recordQuestionAttempt(
                    userId,
                    currentQuestionData.id,
                    userAnswer,
                    isCorrectAnswer,
                    currentQuestionData.difficulty // Use the question's difficulty, not the user's current difficulty
                );


                correctAnswerDisplay.textContent = `The correct answer was: ${actualCorrectAnswer}`;
                solutionArea.classList.add('visible'); // Show solution
                submitAnswerBtn.disabled = true; // Disable submit button after answer
                nextQuestionBtn.disabled = false; // Enable next question button
                answersContainer.querySelectorAll('input').forEach(input => input.disabled = true); // Disable answer inputs
                flagQuestionBtn.classList.add('hidden'); // Hide flag button after submission (or disable it, based on preference)
            }

            async function updateDifficulty(isCorrect) {
                let newDifficulty = currentDifficulty;
                if (isCorrect) {
                    newDifficulty = Math.min(MAX_DIFFICULTY, currentDifficulty + 1);
                } else {
                    newDifficulty = Math.max(MIN_DIFFICULTY, currentDifficulty - 1);
                }

                // Only update if difficulty actually changes
                if (newDifficulty !== currentDifficulty) {
                    currentDifficulty = newDifficulty;
                    try {
                        const response = await fetch('/api/user/update-topic-difficulty', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ userId, topicId, newDifficulty: currentDifficulty })
                        });
                        if (!response.ok) {
                            console.error("Failed to update difficulty on server.");
                        }
                    } catch (error) {
                        console.error("Error updating difficulty:", error);
                    }
                }
            }

            // NEW: Function to record question attempt
            async function recordQuestionAttempt(userId, questionId, userAnswer, isCorrect, difficultyAtAttempt) {
                try {
                    const response = await fetch('/api/record-question-attempt', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: parseInt(userId),
                            questionId: parseInt(questionId),
                            userAnswer: userAnswer,
                            isCorrect: isCorrect,
                            difficultyAtAttempt: parseInt(difficultyAtAttempt)
                        })
                    });
                    if (!response.ok) {
                        console.error("Failed to record question attempt on server.");
                    }
                } catch (error) {
                    console.error("Error recording question attempt:", error);
                }
            }

            // Flagging function (reused from story-player.html)
            async function flagItem(flaggedItemId, itemType, itemIdentifier) {
                const reason = await openFlagModal();
                if (reason === null) {
                    alert('Flagging cancelled.');
                    return;
                }

                try {
                    const response = await fetch('/api/flag-item', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: parseInt(userId),
                            flaggedItemId: parseInt(flaggedItemId),
                            itemType: itemType,
                            reason: reason.trim()
                        })
                    });

                    const result = await response.json();
                    if (response.ok) {
                        alert(result.message || `Thank you! This ${itemType} has been flagged for review.`);
                        flagQuestionBtn.disabled = true;
                        flagQuestionBtn.textContent = 'Flagged';
                        flagQuestionBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        alert(`Failed to flag ${itemType}: ` + (result.message || 'An unknown error occurred.'));
                    }
                } catch (error) {
                    console.error("Error flagging item:", error);
                    alert(`Could not flag ${itemType}. Please check your connection.`);
                }
            }

            // --- Event Listeners ---
            submitAnswerBtn.addEventListener('click', handleSubmitAnswer);
            nextQuestionBtn.addEventListener('click', fetchQuestion);
            backToDashboardBtn.addEventListener('click', () => {
                window.location.href = '/dashboard.html';
            });
            flagQuestionBtn.addEventListener('click', () => {
                if (currentQuestionData && currentQuestionData.id) {
                    flagItem(currentQuestionData.id, 'Question', currentQuestionData.text);
                } else {
                    alert('No question data available to flag.');
                }
            });


            // Initial fetch
            fetchQuestion();
        });
    </script>
    <!-- Back to Top button -->
    <button id="backToTop" aria-label="Back to top"
      class="hidden fixed bottom-20 right-4 px-4 py-2 rounded-full bg-yellow-400 text-black shadow-lg transition-opacity duration-300">
      ↑ Top
    </button>
    <script src="/static/js/flagModal.js"></script>
    <script src="/static/js/flagErrorButton.js"></script>
    <script src="/static/js/backToTop.js"></script>
</body>
</html>
