<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="/static/css/styles.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Pacifico&display=swap" rel="stylesheet">
</head>
<body class="bg-slate-900 text-gray-200 font-nunito">
    <!-- Essential security scripts must be loaded first -->
    <script src="/static/js/secureDOM.js"></script>
    <script src="/static/js/csrf.js"></script>
    <script src="/static/js/authUtils.js"></script>
    
    <!-- Header -->
    <header class="bg-slate-900 border-b border-slate-700">
        <div class="px-6 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-white">Admin Dashboard</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="welcome-username" class="text-white font-medium"></div>
                    <button id="signOutButton" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition-colors">
                        Sign Out
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Navigation Tabs -->
    <nav class="bg-slate-800 border-b border-slate-700">
        <div class="px-6">
            <div class="flex space-x-8">
                <button class="admin-tab px-3 py-3 text-sm font-medium border-b-2 border-yellow-400 text-yellow-400" data-tab="users">
                    User Management
                </button>
                <button class="admin-tab px-3 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-gray-300" data-tab="questions">
                    Question Management
                </button>
                <button class="admin-tab px-3 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-gray-300" data-tab="stories">
                    Story Management
                </button>
                <button class="admin-tab px-3 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-gray-300" data-tab="images">
                    Image Generator
                </button>
                <button class="admin-tab px-3 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-gray-300" data-tab="flagged">
                    Flagged Items
                </button>
                <button class="admin-tab px-3 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-gray-300" data-tab="attempts">
                    Question Attempts
                </button>
                <button class="admin-tab px-3 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-gray-300" data-tab="curriculum">
                    Curriculum Management
                </button>
                <button class="admin-tab px-3 py-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-white hover:border-gray-300" data-tab="videos">
                    Video Management
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 bg-slate-900">
        <!-- User Management Tab -->
        <div id="users-tab" class="admin-tab-content">
            <div class="p-6">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-white mb-4">All Users</h2>
                    <div class="flex gap-4 mb-4">
                        <select id="user-filter-column" class="bg-slate-700 text-white border border-slate-600 rounded px-3 py-2 text-sm">
                            <option value="all">All Columns</option>
                            <option value="Username">Username</option>
                            <option value="Email">Email</option>
                            <option value="UserType">Type</option>
                            <option value="ParentUsername">Parent</option>
                        </select>
                        <input type="text" id="user-filter" placeholder="Search users..." 
                               class="bg-slate-700 text-white border border-slate-600 rounded px-3 py-2 text-sm flex-1 max-w-md">
                    </div>
                </div>
                
                <div class="bg-slate-800 rounded-lg overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-slate-700">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">ID</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Username</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Type</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Parent</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Created On</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Subscription</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body" class="bg-slate-800 divide-y divide-slate-700">
                            <!-- User rows will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Other Tabs (Initially Hidden) -->
        <div id="questions-tab" class="admin-tab-content hidden">
            <div class="p-6">
                <h2 class="text-xl font-bold text-white mb-4">Question Management</h2>
                <div class="bg-slate-800 rounded-lg p-6">
                    <p class="text-gray-400">Question management features coming soon...</p>
                </div>
            </div>
        </div>

        <div id="stories-tab" class="admin-tab-content hidden">
            <div class="p-6">
                <h2 class="text-xl font-bold text-white mb-4">Story Management</h2>
                <div class="bg-slate-800 rounded-lg p-6">
                    <p class="text-gray-400">Story management features coming soon...</p>
                </div>
            </div>
        </div>

        <div id="images-tab" class="admin-tab-content hidden">
            <div class="p-6">
                <h2 class="text-xl font-bold text-white mb-4">Image Generator</h2>
                <div class="bg-slate-800 rounded-lg p-6">
                    <p class="text-gray-400">Image generation tools coming soon...</p>
                </div>
            </div>
        </div>

        <div id="flagged-tab" class="admin-tab-content hidden">
            <div class="p-6">
                <h2 class="text-xl font-bold text-white mb-4">Flagged Items</h2>
                <div class="bg-slate-800 rounded-lg p-6">
                    <p class="text-gray-400">Flagged content management coming soon...</p>
                </div>
            </div>
        </div>

        <div id="attempts-tab" class="admin-tab-content hidden">
            <div class="p-6">
                <h2 class="text-xl font-bold text-white mb-4">Question Attempts</h2>
                <div class="bg-slate-800 rounded-lg p-6">
                    <p class="text-gray-400">Question attempts tracking coming soon...</p>
                </div>
            </div>
        </div>

        <div id="curriculum-tab" class="admin-tab-content hidden">
            <div class="p-6">
                <h2 class="text-xl font-bold text-white mb-4">Curriculum Management</h2>
                <div class="bg-slate-800 rounded-lg p-6">
                    <p class="text-gray-400">Curriculum management features coming soon...</p>
                </div>
            </div>
        </div>

        <div id="videos-tab" class="admin-tab-content hidden">
            <div class="p-6">
                <h2 class="text-xl font-bold text-white mb-4">Video Management</h2>
                <div class="bg-slate-800 rounded-lg p-6">
                    <p class="text-gray-400">Video management features coming soon...</p>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Load admin scripts after DOM is ready -->
    <script src="/static/js/userTable.js"></script>
    <script>
        // Authentication helper functions
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }
        
        function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('token');
            return fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
        }
        
        // Admin API functions - include reference to api/admin/
        async function loadFromAPI() {
            try {
                const response = await authenticatedFetch('/api/admin/users');
                if (response.ok) {
                    const data = await response.json();
                    return data;
                }
            } catch (error) {
                console.error('API load error:', error);
            }
            return null;
        }
        
        // Editor utility functions
        const waitForOption = (selector, timeout = 5000) => {
            return new Promise((resolve, reject) => {
                const element = document.querySelector(selector);
                if (element) {
                    resolve(element);
                    return;
                }
                
                const observer = new MutationObserver(() => {
                    const element = document.querySelector(selector);
                    if (element) {
                        observer.disconnect();
                        resolve(element);
                    }
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
                
                setTimeout(() => {
                    observer.disconnect();
                    reject(new Error(`Element ${selector} not found within ${timeout}ms`));
                }, timeout);
            });
        };
        
        // Editor button handlers
        document.addEventListener('click', function(e) {
            if (e.target.closest('.edit-story-btn')) {
                const button = e.target.closest('.edit-story-btn');
                console.log('Edit story clicked:', button);
            }
            
            if (e.target.closest('.edit-topic-btn')) {
                const button = e.target.closest('.edit-topic-btn');
                console.log('Edit topic clicked:', button);
            }
        });
        
        // Sign out functionality
        function handleSignOut() {
            localStorage.clear();
            window.location.href = '/';
        }
        
        // Load dashboard statistics
        async function loadDashboardStats() {
            try {
                const token = localStorage.getItem('token');
                if (!token) return;
                
                // Load user statistics
                const userStats = await fetch('/api/admin/user-stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (userStats.ok) {
                    const stats = await userStats.json();
                    document.getElementById('total-users').textContent = stats.totalUsers || '0';
                    document.getElementById('active-students').textContent = stats.activeStudents || '0';
                    document.getElementById('total-parents').textContent = stats.totalParents || '0';
                    document.getElementById('stories-completed').textContent = stats.storiesCompleted || '0';
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('iygrighukijh.html script loaded.');
            
            // Add event listeners
            document.getElementById('signOutButton').addEventListener('click', handleSignOut);
            
            // Check if already logged in
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');
            
            if (token && username) {
                document.getElementById('welcome-username').textContent = `Welcome, ${username}!`;
                
                // Load dashboard data
                loadDashboardStats();
                
                // Try to load users if already authenticated
                if (typeof fetchAndRenderUsers === 'function') {
                    fetchAndRenderUsers();
                }
            } else {
                // Redirect to login if not authenticated
                window.location.href = '/signin.html';
            }
        });
    </script>
</body>
</html>
