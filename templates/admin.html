<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
        .glow-button { box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
        .modal-hidden { display: none !important; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content {
            transition: transform 0.3s ease;
            /* FIX: Allow scrolling within modal content */
            max-height: 90vh; /* Limit height to viewport height */
            overflow-y: auto; /* Enable vertical scrolling */
        }
        .tab-button.active {
            border-bottom-color: #f59e0b; /* amber-500 */
            color: #f59e0b;
        }
        .story-section {
            transition: background-color 0.2s;
            border: 1px solid #334155; /* slate-700 */
        }
        .story-section:hover { background-color: rgba(255, 255, 255, 0.05); }
        /* Specific styling for flag status */
        .status-Pending { background-color: rgba(251, 191, 36, 0.2); color: #fbbf24; } /* amber-200 */
        .status-Reviewed { background-color: rgba(34, 197, 94, 0.2); color: #4CAF50; } /* green-500 */
        .status-Dismissed { background-color: rgba(100, 116, 139, 0.2); color: #64748b; } /* slate-500 */

        /* Styles for correct/incorrect answers in attempts table */
        .attempt-correct { color: #34d399; } /* green-400 */
        .attempt-incorrect { color: #ef4444; } /* red-500 */
    </style>
</head>
<body class="bg-slate-900 text-gray-200">

    <header class="bg-slate-800/80 backdrop-blur-sm sticky top-0 z-50 border-b border-slate-700">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-white">Admin Dashboard</h1>
            <button id="mobile-menu-toggle" class="md:hidden text-gray-200 focus:outline-none">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <div class="hidden md:flex items-center space-x-4">
                <span id="welcome-username" class="font-semibold text-white"></span>
                <button id="signOutButton" class="bg-red-600 text-white font-bold py-2 px-5 rounded-full hover:bg-red-500 glow-button">Sign Out</button>
            </div>
        </nav>
        <div id="mobile-menu" class="md:hidden hidden px-6 pb-4">
            <span id="welcome-username-mobile" class="block py-2 font-semibold text-white"></span>
            <button id="signOutButtonMobile" class="bg-red-600 text-white font-bold py-2 px-5 rounded-full hover:bg-red-500 glow-button mt-2">Sign Out</button>
        </div>
    </header>

    <main class="container mx-auto px-6 py-12">
        <div class="border-b border-slate-700 mb-8">
            <nav class="flex space-x-8" aria-label="Tabs">
                <button id="users-tab-btn" class="tab-button active text-lg font-medium text-gray-400 hover:text-amber-500 py-4 px-1 border-b-2 border-transparent">User Management</button>
                <button id="questions-tab-btn" class="tab-button text-lg font-medium text-gray-400 hover:text-amber-500 py-4 px-1 border-b-2 border-transparent">Question Management</button>
                <button id="stories-tab-btn" class="tab-button text-lg font-medium text-gray-400 hover:text-amber-500 py-4 px-1 border-b-2 border-transparent">Story Management</button>
                <button id="flags-tab-btn" class="tab-button text-lg font-medium text-gray-400 hover:text-amber-500 py-4 px-1 border-b-2 border-transparent">Flagged Items</button>
                <button id="attempts-tab-btn" class="tab-button text-lg font-medium text-gray-400 hover:text-amber-500 py-4 px-1 border-b-2 border-transparent">Question Attempts</button>
                <button id="curriculums-tab-btn" class="tab-button text-lg font-medium text-gray-400 hover:text-amber-500 py-4 px-1 border-b-2 border-transparent">Curriculum Management</button>
            </nav>
        </div>

        <div id="admin-message" class="text-center text-lg font-bold mb-4 h-6"></div>

        <div id="users-section">
            <h2 class="text-3xl font-bold text-white mb-6">All Users</h2>
            <div class="mb-4 flex flex-col md:flex-row md:items-center md:space-x-4">
                <select id="user-filter-column" class="mb-2 md:mb-0 bg-slate-700 rounded-lg p-2 w-full md:w-48">
                    <option value="all" selected>All Columns</option>
                    <option value="ID">ID</option>
                    <option value="Username">Username</option>
                    <option value="Email">Email</option>
                    <option value="UserType">Type</option>
                    <option value="ParentUsername">Parent</option>
                </select>
                <input id="user-filter" type="text" class="w-full md:w-1/3 bg-slate-700 rounded-lg p-2" placeholder="Search users...">
            </div>
            <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-x-auto">
                <table class="min-w-full text-left text-sm"><thead class="border-b border-slate-700 font-medium"><tr><th class="px-6 py-4">ID</th><th class="px-6 py-4">Username</th><th class="px-6 py-4">Email</th><th class="px-6 py-4">Type</th><th class="px-6 py-4">Parent</th><th class="px-6 py-4">Created On</th><th class="px-6 py-4 text-center">Actions</th></tr></thead><tbody id="user-table-body"></tbody></table>
            </div>
        </div>

        <div id="questions-section" class="hidden">
            <h2 class="text-3xl font-bold text-white mb-6">Add a New Question</h2>
            <div class="bg-slate-800 rounded-2xl border border-slate-700 p-8 mb-12">
                <form id="addQuestionForm">
                    <div class="mb-6">
                        <label class="block text-gray-300 mb-2 font-bold">1. Select Topic</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div id="q-curriculum-container"></div>
                            <div id="q-unit-container"></div>
                            <div id="q-topic-container"></div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-300 mb-2 font-bold">2. Question Type</label>
                        <div class="flex space-x-6 items-center bg-slate-700/50 p-3 rounded-lg">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="question-type" value="MultipleChoice" class="h-5 w-5" checked>
                                <span class="ml-2 text-white">Multiple Choice</span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="question-type" value="OpenEnded" class="h-5 w-5">
                                <span class="ml-2 text-white">Open Ended</span>
                            </label>
                        </div>
                    </div>
                    <div class="mb-6">
                        <label for="question-text" class="block text-gray-300 mb-2 font-bold">3. Question Text</label>
                        <textarea id="question-text" rows="3" class="w-full bg-slate-700 border-slate-600 rounded-lg p-2 text-white" required></textarea>
                    </div>
                    <div id="multiple-choice-section" class="mb-6">
                        <label class="block text-gray-300 mb-2 font-bold">4. Answers</label>
                        <div id="answers-container" class="space-y-3"></div>
                        <button type="button" id="add-answer-btn" class="mt-3 bg-blue-600 text-white font-semibold py-2 px-4 text-sm rounded-full hover:bg-blue-500">+ Add Answer</button>
                    </div>
                    <div id="open-ended-section" class="mb-6 hidden">
                        <label class="block text-gray-300 mb-2 font-bold">4. Correct Answer</label>
                        <input type="text" id="open-ended-answer" class="w-full bg-slate-700 border-slate-600 rounded-lg p-2 text-white">
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-300 mb-2 font-bold">5. Solution Steps</label>
                        <div id="steps-container" class="space-y-3"></div>
                        <button type="button" id="add-step-btn" class="mt-3 bg-blue-600 text-white font-semibold py-2 px-4 text-sm rounded-full hover:bg-blue-500">+ Add Step</button>
                    </div>
                    <div class="mb-6">
                        <label for="difficulty-rating" class="block text-gray-300 mb-2 font-bold">6. Difficulty Rating (1-5)</label>
                        <select id="difficulty-rating" class="w-full bg-slate-700 border-slate-600 rounded-lg p-2 text-white" required>
                            <option value="1">1 (Easiest)</option>
                            <option value="2">2</option>
                            <option value="3" selected>3 (Medium)</option>
                            <option value="4">4</option>
                            <option value="5">5 (Hardest)</option>
                        </select>
                    </div>
                    <div id="question-form-message" class="text-center mb-4 h-5"></div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-full text-lg">Submit New Question</button>
                </form>
            </div>

            <h2 class="text-3xl font-bold text-white mb-6">Existing Questions</h2>
            <div class="mb-4 flex flex-col md:flex-row md:items-center md:space-x-4">
                <select id="question-filter-column" class="mb-2 md:mb-0 bg-slate-700 rounded-lg p-2 w-full md:w-48">
                    <option value="all" selected>All Columns</option>
                    <option value="QuestionName">Name</option>
                    <option value="QuestionType">Type</option>
                    <option value="DifficultyRating">Difficulty</option>
                    <option value="TopicName">Topic</option>
                </select>
                <input id="question-filter" type="text" class="w-full md:w-1/3 bg-slate-700 rounded-lg p-2" placeholder="Search questions...">
            </div>
            <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-x-auto p-6">
                <div id="existing-questions-list" class="space-y-4">
                    <p class="text-center text-gray-400">Loading questions...</p>
                </div>
            </div>
        </div>

        <div id="stories-section" class="hidden">
            <h2 class="text-3xl font-bold text-white mb-6">Build a Story</h2>
            <div class="bg-slate-800 rounded-2xl border-slate-700 p-8 mb-12">
                <div class="mb-6">
                    <label class="block text-gray-300 mb-2 font-bold">1. Select Topic</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div id="s-curriculum-container"></div>
                        <div id="s-unit-container"></div>
                        <div id="s-topic-container"></div>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="story-theme-select" class="block text-gray-300 mb-2 font-bold">2. Select Story Theme</label>
                    <select id="story-theme-select" class="w-full bg-slate-700 p-3 rounded-lg" required>
                        <option value="">-- Select Theme --</option>
                        <option value="Detective">Detective</option>
                        <option value="Fantasy">Fantasy</option>
                        <option value="Indian Epics">Indian Epics</option>
                    </select>
                </div>
                <div id="story-builder-area" class="mt-8 border-t border-slate-700 pt-6">
                    <label class="block text-gray-300 mb-2 font-bold">3. Construct the Story</label>
                    <div id="story-builder-container" class="min-h-[10rem] bg-slate-900/50 p-4 rounded-lg border-2 border-dashed border-slate-700 space-y-4">
                        <p class="text-center text-gray-500">Add sections to build your story.</p>
                    </div>
                    <div class="flex items-center space-x-4 mt-4">
                        <button id="add-section-btn" class="bg-blue-600 text-white font-semibold py-2 px-5 rounded-full hover:bg-blue-500">Add Section</button>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <div id="story-form-message" class="text-center mb-4 h-5"></div>
                    <button id="save-story-btn" class="w-full max-w-md bg-green-600 text-white font-bold py-3 rounded-full text-lg">Save Story</button>
                </div>
            </div>

            <h2 class="text-3xl font-bold text-white mb-6">Existing Stories</h2>
            <div class="mb-4 flex flex-col md:flex-row md:items-center md:space-x-4">
                <select id="story-filter-column" class="mb-2 md:mb-0 bg-slate-700 rounded-lg p-2 w-full md:w-48">
                    <option value="all" selected>All Columns</option>
                    <option value="TopicID">Topic ID</option>
                    <option value="TopicName">Topic Name</option>
                    <option value="DefaultTheme">Theme</option>
                </select>
                <input id="story-filter" type="text" class="w-full md:w-1/3 bg-slate-700 rounded-lg p-2" placeholder="Search stories...">
            </div>
            <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-x-auto p-6">
                <div id="existing-stories-list" class="space-y-4">
                    <p class="text-center text-gray-400">Loading stories...</p>
                </div>
            </div>
        </div>

        <div id="flags-section" class="hidden">
            <h2 class="text-3xl font-bold text-white mb-6">Flagged Items</h2>
            <div class="mb-4 flex flex-col md:flex-row md:items-center md:space-x-4">
                <select id="flag-filter-column" class="mb-2 md:mb-0 bg-slate-700 rounded-lg p-2 w-full md:w-48">
                    <option value="all" selected>All Columns</option>
                    <option value="FlagID">Flag ID</option>
                    <option value="ItemType">Type</option>
                    <option value="ItemName">Name</option>
                    <option value="ReporterUsername">Reporter</option>
                    <option value="Status">Status</option>
                </select>
                <input id="flag-filter" type="text" class="w-full md:w-1/3 bg-slate-700 rounded-lg p-2" placeholder="Search flags...">
            </div>
            <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-x-auto p-6">
                <div id="flagged-items-list" class="space-y-4">
                    <p class="text-center text-gray-400">Loading flagged items...</p>
                </div>
            </div>
        </div>

        <div id="attempts-section" class="hidden">
            <h2 class="text-3xl font-bold text-white mb-6">All Question Attempts</h2>
            <div class="mb-4 flex flex-col md:flex-row md:items-center md:space-x-4">
                <select id="attempt-filter-column" class="mb-2 md:mb-0 bg-slate-700 rounded-lg p-2 w-full md:w-48">
                    <option value="all" selected>All Columns</option>
                    <option value="AttemptID">Attempt ID</option>
                    <option value="AttemptingUsername">User</option>
                    <option value="QuestionText">Question</option>
                    <option value="IsCorrect">Correct?</option>
                    <option value="TopicName">Topic</option>
                </select>
                <input id="attempt-filter" type="text" class="w-full md:w-1/3 bg-slate-700 rounded-lg p-2" placeholder="Search attempts...">
            </div>
            <div class="bg-slate-800 rounded-2xl border border-slate-700 overflow-x-auto">
                <table class="min-w-full text-left text-sm">
                    <thead class="border-b border-slate-700 font-medium">
                        <tr>
                            <th class="px-6 py-4">Attempt ID</th>
                            <th class="px-6 py-4">Time</th>
                            <th class="px-6 py-4">User</th>
                            <th class="px-6 py-4">Question</th>
                            <th class="px-6 py-4">User Answer</th>
                            <th class="px-6 py-4">Correct?</th>
                            <th class="px-6 py-4">Correct Answer</th> <th class="px-6 py-4">Difficulty</th>
                            <th class="px-6 py-4">Topic (Unit)</th>
                        </tr>
                    </thead>
                    <tbody id="attempts-table-body">
                        <tr><td colspan="9" class="text-center py-4 text-gray-400">Loading attempts...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="curriculums-section" class="hidden">
            <h2 class="text-3xl font-bold text-white mb-6">Curriculums</h2>
            <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 overflow-x-auto mb-6">
                <table class="min-w-full text-left text-sm">
                    <thead class="border-b border-slate-700 font-medium">
                        <tr>
                            <th class="px-4 py-2">Grade</th>
                            <th class="px-4 py-2">Curriculum</th>
                            <th class="px-4 py-2">Unit</th>
                            <th class="px-4 py-2">Topic</th>
                        </tr>
                    </thead>
                    <tbody id="curriculum-table-body">
                        <tr><td colspan="4" class="text-center py-4 text-gray-400">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 mb-6">
                <h3 class="text-xl font-bold text-white mb-4">Seed Database</h3>
                <form id="seedDatabaseForm" class="flex flex-col md:flex-row gap-4" enctype="multipart/form-data">
                    <input type="file" id="seed-file" name="file" accept=".csv" class="flex-1 bg-slate-700 rounded-lg p-2" required>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-full">Upload</button>
                </form>
                <div id="seed-database-message" class="text-center mt-4 h-5"></div>
            </div>
            <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6 mb-6">
                <h3 class="text-xl font-bold text-white mb-4">Add Curriculum</h3>
                <form id="createCurriculumForm" class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="new-curriculum-name" class="flex-1 bg-slate-700 rounded-lg p-2" placeholder="Curriculum name" required>
                    <button type="submit" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-full">Create</button>
                </form>
                <div id="create-curriculum-message" class="text-center mt-4 h-5"></div>
            </div>
            <div class="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                <div id="existing-curriculums-list" class="space-y-4">
                    <p class="text-center text-gray-400">Loading curriculums...</p>
                </div>
            </div>
        </div>

    </main>

    <div id="editUserModal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center opacity-0"><div class="modal-content bg-slate-800 rounded-2xl p-8 max-w-lg w-full mx-4 relative scale-95"><button class="close-modal absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">×</button><h2 class="text-2xl font-bold text-white text-center mb-6">Edit User</h2><form id="editUserForm"><input type="hidden" id="edit-userid"><div class="mb-4"><label for="edit-username" class="block text-gray-300 mb-2">Username</label><input type="text" id="edit-username" class="w-full bg-slate-700 rounded-lg p-2" required></div><div class="mb-4"><label for="edit-email" class="block text-gray-300 mb-2">Email</label><input type="email" id="edit-email" class="w-full bg-slate-700 rounded-lg p-2" required></div><div class="mb-6"><label for="edit-usertype" class="block text-gray-300 mb-2">User Type</label><select id="edit-usertype" class="w-full bg-slate-700 rounded-lg p-2"><option value="Parent">Parent</option><option value="Student">Student</option></select></div><div id="edit-message" class="text-center mb-4 h-5"></div><button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-full">Save Changes</button></form></div></div>

    <div id="editQuestionModal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center opacity-0">
        <div class="modal-content bg-slate-800 rounded-2xl p-8 max-w-2xl w-full mx-4 relative scale-95">
            <button class="close-modal absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">×</button>
            <h2 class="text-2xl font-bold text-white text-center mb-6">Edit Question</h2>
            <form id="editQuestionForm">
                <input type="hidden" id="edit-question-id">

                <div class="mb-6">
                    <label class="block text-gray-300 mb-2 font-bold">1. Select Topic</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div id="edit-q-curriculum-container"></div>
                        <div id="edit-q-unit-container"></div>
                        <div id="edit-q-topic-container"></div>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-300 mb-2 font-bold">2. Question Type</label>
                    <div class="flex space-x-6 items-center bg-slate-700/50 p-3 rounded-lg">
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="edit-question-type" value="MultipleChoice" class="h-5 w-5">
                            <span class="ml-2 text-white">Multiple Choice</span>
                        </label>
                        <label class="flex items-center cursor-pointer">
                            <input type="radio" name="edit-question-type" value="OpenEnded" class="h-5 w-5">
                            <span class="ml-2 text-white">Open Ended</span>
                        </label>
                    </div>
                </div>

                <div class="mb-6">
                    <label for="edit-question-text" class="block text-gray-300 mb-2 font-bold">3. Question Text</label>
                    <textarea id="edit-question-text" rows="3" class="w-full bg-slate-700 border-slate-600 rounded-lg p-2 text-white" required></textarea>
                </div>

                <div id="edit-multiple-choice-section" class="mb-6">
                    <label class="block text-gray-300 mb-2 font-bold">4. Answers</label>
                    <div id="edit-answers-container" class="space-y-3"></div>
                    <button type="button" id="edit-add-answer-btn" class="mt-3 bg-blue-600 text-white font-semibold py-2 px-4 text-sm rounded-full hover:bg-blue-500">+ Add Answer</button>
                </div>

                <div id="edit-open-ended-section" class="mb-6 hidden">
                    <label class="block text-gray-300 mb-2 font-bold">4. Correct Answer</label>
                    <input type="text" id="edit-open-ended-answer" class="w-full bg-slate-700 border-slate-600 rounded-lg p-2 text-white">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-300 mb-2 font-bold">5. Solution Steps</label>
                    <div id="edit-steps-container" class="space-y-3"></div>
                    <button type="button" id="edit-add-step-btn" class="mt-3 bg-blue-600 text-white font-semibold py-2 px-4 text-sm rounded-full hover:bg-blue-500">+ Add Step</button>
                </div>
                <div class="mb-6">
                    <label for="edit-difficulty-rating" class="block text-gray-300 mb-2 font-bold">6. Difficulty Rating (1-5)</label>
                    <select id="edit-difficulty-rating" class="w-full bg-slate-700 border-slate-600 rounded-lg p-2 text-white" required>
                        <option value="1">1 (Easiest)</option>
                        <option value="2">2</option>
                        <option value="3">3 (Medium)</option>
                        <option value="4">4</option>
                        <option value="5">5 (Hardest)</option>
                    </select>
                </div>
                <div id="edit-question-form-message" class="text-center mb-4 h-5"></div>
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-full text-lg">Save Changes</button>
            </form>
        </div>
    </div>
    <div id="editCurriculumModal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center opacity-0">
        <div class="modal-content bg-slate-800 rounded-2xl p-8 max-w-lg w-full mx-4 relative scale-95">
            <button class="close-modal absolute top-4 right-4 text-gray-400 hover:text-white text-3xl leading-none">×</button>
            <h2 class="text-2xl font-bold text-white text-center mb-6">Edit Curriculum</h2>
            <form id="editCurriculumForm">
                <input type="hidden" id="edit-curriculum-id">
                <div class="mb-4">
                    <label for="edit-curriculum-name" class="block text-gray-300 mb-2">Name</label>
                    <input type="text" id="edit-curriculum-name" class="w-full bg-slate-700 rounded-lg p-2" required>
                </div>
                <div id="edit-curriculum-message" class="text-center mb-4 h-5"></div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-full">Save Changes</button>
            </form>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("admin.html script loaded."); // ADD THIS LOG
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            const welcomeMobile = document.getElementById('welcome-username-mobile');
            const signOutButtonMobile = document.getElementById('signOutButtonMobile');

            if (welcomeMobile) {
                welcomeMobile.textContent = document.getElementById('welcome-username').textContent;
            }

            if (mobileMenuToggle && mobileMenu) {
                mobileMenuToggle.addEventListener('click', () => {
                    mobileMenu.classList.toggle('hidden');
                });
            }
            const adminId = localStorage.getItem('userId'); // Get admin's ID for resolving flags
            if (localStorage.getItem('userType') !== 'Admin' || !adminId) {
                alert("Access Denied.");
                window.location.href = '/';
                return;
            }

            const adminUsername = localStorage.getItem('username');
            document.getElementById('welcome-username').textContent = `Welcome, ${adminUsername}!`;
            const adminMessageDiv = document.getElementById('admin-message');
            let hierarchicalTopics = {};

            const userTableBody = document.getElementById('user-table-body');
            const editUserModal = document.getElementById('editUserModal');
            const editUserForm = document.getElementById('editUserForm');
            const editMessageDiv = document.getElementById('edit-message');
            const addQuestionForm = document.getElementById('addQuestionForm');
            const answersContainer = document.getElementById('answers-container');
            const stepsContainer = document.getElementById('steps-container');
            const addAnswerBtn = document.getElementById('add-answer-btn');
            const addStepBtn = document.getElementById('add-step-btn');
            const questionFormMessage = document.getElementById('question-form-message');
            const questionTypeRadios = document.querySelectorAll('input[name="question-type"]');
            const multipleChoiceSection = document.getElementById('multiple-choice-section');
            const openEndedSection = document.getElementById('open-ended-section');
            const difficultyRatingSelect = document.getElementById('difficulty-rating');

            const storyBuilderContainer = document.getElementById('story-builder-container');
            const addSectionBtn = document.getElementById('add-section-btn');
            const saveStoryBtn = document.getElementById('save-story-btn');
            const storyFormMessage = document.getElementById('story-form-message');
            const storyThemeSelect = document.getElementById('story-theme-select'); // NEW: Get theme select element

            const usersTabBtn = document.getElementById('users-tab-btn');
            const questionsTabBtn = document.getElementById('questions-tab-btn');
            const storiesTabBtn = document.getElementById('stories-tab-btn');
            const flagsTabBtn = document.getElementById('flags-tab-btn');
            const attemptsTabBtn = document.getElementById('attempts-tab-btn'); // NEW

            const usersSection = document.getElementById('users-section');
            const questionsSection = document.getElementById('questions-section');
            const storiesSection = document.getElementById('stories-section');
            const flagsSection = document.getElementById('flags-section');
            const attemptsSection = document.getElementById('attempts-section'); // NEW

            const existingQuestionsList = document.getElementById('existing-questions-list');
            const existingStoriesList = document.getElementById('existing-stories-list');
            const flaggedItemsList = document.getElementById('flagged-items-list');
            const attemptsTableBody = document.getElementById('attempts-table-body'); // NEW

            const questionFilterInput = document.getElementById('question-filter');
            const questionFilterColumn = document.getElementById('question-filter-column');
            const storyFilterInput = document.getElementById('story-filter');
            const storyFilterColumn = document.getElementById('story-filter-column');
            const flagFilterInput = document.getElementById('flag-filter');
            const flagFilterColumn = document.getElementById('flag-filter-column');
            const attemptFilterInput = document.getElementById('attempt-filter');
            const attemptFilterColumn = document.getElementById('attempt-filter-column');

            // NEW: Edit Question Modal elements
            const editQuestionModal = document.getElementById('editQuestionModal');
            const editQuestionForm = document.getElementById('editQuestionForm');
            const editQuestionIdInput = document.getElementById('edit-question-id');
            const editQuestionTypeRadios = document.querySelectorAll('input[name="edit-question-type"]');
            const editQuestionTextInput = document.getElementById('edit-question-text');
            const editAnswersContainer = document.getElementById('edit-answers-container');
            const editAddAnswerBtn = document.getElementById('edit-add-answer-btn');
            const editStepsContainer = document.getElementById('edit-steps-container');
            const editAddStepBtn = document.getElementById('edit-add-step-btn');
            const editQuestionFormMessage = document.getElementById('edit-question-form-message');
            const editDifficultyRatingSelect = document.getElementById('edit-difficulty-rating');

            const editMultipleChoiceSection = document.getElementById('edit-multiple-choice-section');
            const editOpenEndedSection = document.getElementById('edit-open-ended-section');

            const curriculumsTabBtn = document.getElementById('curriculums-tab-btn');
            const curriculumsSection = document.getElementById('curriculums-section');
            const existingCurriculumsList = document.getElementById('existing-curriculums-list');
            const editCurriculumModal = document.getElementById('editCurriculumModal');
            const editCurriculumForm = document.getElementById('editCurriculumForm');
            const editCurriculumIdInput = document.getElementById('edit-curriculum-id');
            const editCurriculumNameInput = document.getElementById('edit-curriculum-name');
            const editCurriculumMessage = document.getElementById('edit-curriculum-message');
            const curriculumTableBody = document.getElementById('curriculum-table-body');
            const createCurriculumForm = document.getElementById('createCurriculumForm');
            const newCurriculumNameInput = document.getElementById('new-curriculum-name');
            const createCurriculumMessage = document.getElementById('create-curriculum-message');
            const seedDatabaseForm = document.getElementById('seedDatabaseForm');
            const seedFileInput = document.getElementById('seed-file');
            const seedDatabaseMessage = document.getElementById('seed-database-message');

            // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            // createCascadingSelectors FUNCTION DEFINITION - MOVED HERE
            // This entire function block must be defined BEFORE it is used below.
            // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

const createCascadingSelectors = (prefix) => {
    const curriculumContainer = document.getElementById(`${prefix}-curriculum-container`);
    const unitContainer = document.getElementById(`${prefix}-unit-container`);
    const topicContainer = document.getElementById(`${prefix}-topic-container`);
    curriculumContainer.innerHTML = `<select id="${prefix}-curriculum-select" class="w-full bg-slate-700 p-3 rounded-lg" required><option value="">-- Select Curriculum --</option></select>`;
    unitContainer.innerHTML = `<select id="${prefix}-unit-select" class="w-full bg-slate-700 p-3 rounded-lg" required disabled><option value="">-- Select Unit --</option></select>`;
    topicContainer.innerHTML = `<select id="${prefix}-topic-select" class="w-full bg-slate-700 p-3 rounded-lg" required disabled><option value="">-- Select Topic --</option></select>`;

    const curriculumSelect = document.getElementById(`${prefix}-curriculum-select`);
    const unitSelect = document.getElementById(`${prefix}-unit-select`);
    const topicSelect = document.getElementById(`${prefix}-topic-select`);

    curriculumSelect.addEventListener('change', async () => {
        const selectedCurriculum = curriculumSelect.value;
        unitSelect.innerHTML = '<option value="">-- Select Unit --</option>';
        topicSelect.innerHTML = '<option value="">-- Select Topic --</option>';
        unitSelect.disabled = true;
        topicSelect.disabled = true;
        if (selectedCurriculum) {
            try {
                const resp = await fetch(`${window.location.origin}/get_units/${encodeURIComponent(selectedCurriculum)}`);
                if (!resp.ok) throw new Error('Failed to load units');
                const units = await resp.json();
                const uniqueUnits = [...new Set(units)];
                uniqueUnits.forEach(u => { unitSelect.innerHTML += `<option value="${u}">${u}</option>`; });
                if (uniqueUnits.length > 0) unitSelect.disabled = false;
                if (!hierarchicalTopics[selectedCurriculum]) hierarchicalTopics[selectedCurriculum] = {};
            } catch (err) {
                console.error('Error fetching units:', err);
            }
        }
    });

    unitSelect.addEventListener('change', async () => {
        const selectedCurriculum = curriculumSelect.value;
        const selectedUnit = unitSelect.value;
        topicSelect.innerHTML = '<option value="">-- Select Topic --</option>';
        topicSelect.disabled = true;
        if (selectedUnit) {
            try {
                const resp = await fetch(`${window.location.origin}/get_topics/${encodeURIComponent(selectedCurriculum)}/${encodeURIComponent(selectedUnit)}`);
                if (!resp.ok) throw new Error('Failed to load topics');
                const topics = await resp.json();
                topics.forEach(t => { topicSelect.innerHTML += `<option value="${t.id}">${t.name}</option>`; });
                if (topics.length > 0) topicSelect.disabled = false;
                if (!hierarchicalTopics[selectedCurriculum]) hierarchicalTopics[selectedCurriculum] = {};
                hierarchicalTopics[selectedCurriculum][selectedUnit] = topics;
            } catch (err) {
                console.error('Error fetching topics:', err);
            }
        }
    });

    return { curriculumSelect, unitSelect, topicSelect };
};

            // These declarations must now come AFTER createCascadingSelectors is defined.
            const questionSelectors = createCascadingSelectors('q');
            const storySelectors = createCascadingSelectors('s');
            const editQuestionSelectors = createCascadingSelectors('edit-q');


            const showModal = (modal) => {
                console.log(`Attempting to show modal: ${modal.id}`);
                modal.classList.remove('modal-hidden', 'opacity-0');
                modal.querySelector('.modal-content').classList.remove('scale-95');
                console.log(`Modal ${modal.id} visibility updated.`);
            };
            const hideModal = (modal) => {
                console.log(`Attempting to hide modal: ${modal.id}`);
                modal.classList.add('opacity-0');
                modal.querySelector('.modal-content').classList.add('scale-95');
                setTimeout(() => modal.classList.add('modal-hidden'), 300);
            };

            // user list is handled by static/js/userTable.js
            const handleDeleteUser = async (userId, username) => {
                if (!confirm(`Are you sure you want to delete the user "${username}"? This action cannot be undone.`)) return;

                try {
                    const response = await fetch(`/api/admin/delete-user/${userId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    adminMessageDiv.textContent = result.message;

                    if (response.ok) {
                        adminMessageDiv.className = 'text-center text-green-400 font-bold text-lg mb-4 h-6';
                        if (window.forceRefreshUsers) window.forceRefreshUsers();
                    } else {
                        adminMessageDiv.className = 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                    }

                } catch (error) {
                    console.error("Delete user fetch error:", error);
                    adminMessageDiv.textContent = 'A connection error occurred.';
                    adminMessageDiv.className = 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                }

                setTimeout(() => { adminMessageDiv.textContent = ''; }, 5000);
            };
            const handleOpenEditModal = (userId) => {
                const users = window.allUsersData || [];
                const userData = users.find(user => user.ID == userId);
                if (!userData) return;
                document.getElementById('edit-userid').value = userData.ID;
                document.getElementById('edit-username').value = userData.Username;
                document.getElementById('edit-email').value = userData.Email;
                document.getElementById('edit-usertype').value = userData.UserType;
                editMessageDiv.textContent = '';
                showModal(editUserModal);
            };
            editUserForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const userId = document.getElementById('edit-userid').value;
                const userData = { username: document.getElementById('edit-username').value, email: document.getElementById('edit-email').value, userType: document.getElementById('edit-usertype').value };
                try {
                    const response = await fetch(`/api/admin/edit-user/${userId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(userData) });
                    const result = await response.json();
                    editMessageDiv.textContent = result.message;
                    editMessageDiv.className = response.ok ? 'text-green-400' : 'text-red-400';
                    if (response.ok) {
                        if (window.forceRefreshUsers) window.forceRefreshUsers();
                        setTimeout(() => hideModal(editUserModal), 1500);
                    }
                } catch (error) { editMessageDiv.textContent = 'Server connection error.'; editMessageDiv.className = 'text-red-400'; }
            });

            const initializeTopicData = async () => {
                try {
                    const response = await fetch(`${window.location.origin}/api/admin/curriculum-hierarchy`);
                    if (!response.ok) throw new Error('Failed to fetch topics');
                    hierarchicalTopics = await response.json();
                } catch (error) {
                    console.error("Fetch topics error:", error);
                }
            };

            const loadCurriculums = async () => {
                try {
                    const resp = await fetch(`${window.location.origin}/get_curriculums`);
                    if (!resp.ok) throw new Error('Failed to fetch curriculums');
                    const curriculums = await resp.json();
                    const uniqueCurriculums = [...new Set(curriculums)];
                    [questionSelectors, storySelectors, editQuestionSelectors].forEach(set => {
                        set.curriculumSelect.innerHTML = '<option value="">-- Select Curriculum --</option>';
                        uniqueCurriculums.forEach(name => { set.curriculumSelect.innerHTML += `<option value="${name}">${name}</option>`; });
                    });
                } catch (error) {
                    console.error('Fetch curriculums error:', error);
                    const msg = document.getElementById('admin-message');
                    if (msg) {
                        msg.textContent = 'Error loading curriculums.';
                        msg.className = 'text-red-400 mb-4';
                    }
                }
            };

            const addAnswerInput = (container, isCorrect = false, text = '', isFirst = false) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-3';
                div.innerHTML = `<input type="radio" name="correct-answer" class="h-5 w-5" ${isCorrect ? 'checked' : ''}><input type="text" name="answer_text" class="answer-text w-full bg-slate-700 p-2 rounded-lg" placeholder="Answer option" value="${text}" required>${!isFirst ? '<button type="button" class="remove-btn text-red-500 text-2xl">×</button>' : ''}`;
                container.appendChild(div);
                div.querySelector('.remove-btn')?.addEventListener('click', () => div.remove());
            };

            const addStepInput = (container, text = '', isFirst = false) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-3';
                div.innerHTML = `<span class="text-gray-400">Step:</span><textarea name="step_text" class="step-text w-full bg-slate-700 p-2 rounded-lg" rows="3" placeholder="Solution step" required>${text}</textarea>${!isFirst ? '<button type="button" class="remove-btn text-red-500 text-2xl">×</button>' : ''}`;
                container.appendChild(div);
                div.querySelector('.remove-btn')?.addEventListener('click', () => div.remove());
            };

            // This function is no longer needed as 'required' and 'disabled' states are managed more directly
            // when switching question types.
            /*
            const toggleSectionInputs = (sectionId, enable) => {
                console.log(`Toggling inputs for section: ${sectionId}, enable: ${enable}`);
                const section = document.getElementById(sectionId);
                if (!section) {
                    console.warn(`Section with ID ${sectionId} not found.`);
                    return;
                }

                const inputs = section.querySelectorAll('input, textarea, select');
                inputs.forEach(input => {
                    if (enable) {
                        input.removeAttribute('disabled');
                        // Only set required if it's an answer/step input AND it's visible.
                        if ((input.classList.contains('answer-text') || input.name === 'correct-answer' || input.id === 'open-ended-answer' || input.classList.contains('step-text')) && !section.classList.contains('hidden')) {
                             input.setAttribute('required', '');
                        }
                    } else {
                        input.setAttribute('disabled', 'true');
                        input.removeAttribute('required'); // Always remove required when disabled/hidden
                    }
                });
            };
            */

            questionTypeRadios.forEach(radio => radio.addEventListener('change', (e) => {
                const isMC = e.target.value === 'MultipleChoice';

                multipleChoiceSection.classList.toggle('hidden', !isMC);
                openEndedSection.classList.toggle('hidden', isMC);

                // Manage required/disabled attributes more precisely
                if (isMC) {
                    // For Multiple Choice:
                    answersContainer.querySelectorAll('.answer-text').forEach(input => input.setAttribute('required', ''));
                    answersContainer.querySelectorAll('input[type="radio"]').forEach(input => input.setAttribute('required', '')); // One radio must be selected
                    document.getElementById('open-ended-answer').removeAttribute('required');
                    document.getElementById('open-ended-answer').setAttribute('disabled', 'true');
                } else {
                    // For Open Ended:
                    document.getElementById('open-ended-answer').setAttribute('required', '');
                    document.getElementById('open-ended-answer').removeAttribute('disabled');
                    answersContainer.querySelectorAll('.answer-text').forEach(input => input.removeAttribute('required'));
                    answersContainer.querySelectorAll('input[type="radio"]').forEach(input => input.removeAttribute('required'));
                }
                
                // Question text and steps are always required regardless of type
                document.getElementById('question-text').setAttribute('required', '');
                stepsContainer.querySelectorAll('.step-text').forEach(input => input.setAttribute('required', ''));
            }));


            addQuestionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                questionFormMessage.textContent = '';
                const questionType = document.querySelector('input[name="question-type"]:checked').value;
                let answers = [];

                const topicId = questionSelectors.topicSelect.value;
                if (!topicId) {
                    questionFormMessage.textContent = 'Please select a topic.';
                    questionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                    return;
                }

                const questionText = document.getElementById('question-text').value;
                if (!questionText) {
                    questionFormMessage.textContent = 'Please enter the question text.';
                    questionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                    return;
                }

                if (questionType === 'MultipleChoice') {
                    const mcAnswerInputs = answersContainer.querySelectorAll('.flex');
                    if (mcAnswerInputs.length === 0) {
                        questionFormMessage.textContent = 'Please add at least one answer option.';
                        questionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                        return;
                    }
                    let hasCorrectAnswer = false;
                    mcAnswerInputs.forEach(div => {
                        const radio = div.querySelector('input[type="radio"]');
                        const textInput = div.querySelector('.answer-text');
                        if (textInput.value) {
                            answers.push({ text: textInput.value, isCorrect: radio.checked });
                            if (radio.checked) hasCorrectAnswer = true;
                        }
                    });
                    if (!hasCorrectAnswer) {
                        questionFormMessage.textContent = 'Please select a correct answer for multiple choice.';
                        questionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                        return;
                    }
                    if (answers.length < 2) {
                        questionFormMessage.textContent = 'Multiple choice questions need at least two answer options.';
                        questionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                        return;
                    }
                } else { // OpenEnded
                    const openEndedAnswer = document.getElementById('open-ended-answer').value;
                    if (!openEndedAnswer) {
                        questionFormMessage.textContent = 'Please provide a correct answer for open-ended questions.';
                        questionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                        return;
                    }
                    answers.push({ text: openEndedAnswer, isCorrect: true });
                }

                const steps = Array.from(stepsContainer.querySelectorAll('.step-text')).map(input => ({ text: input.value })).filter(step => step.text);
                if (steps.length === 0) {
                    questionFormMessage.textContent = 'Please provide at least one solution step.';
                    questionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                    return;
                }

                const difficultyRating = difficultyRatingSelect.value;

                const questionData = { topicId: parseInt(topicId), questionText, questionType, answers, steps, difficultyRating: parseInt(difficultyRating) };

                try {
                    const response = await fetch('/api/admin/add-question', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(questionData) });
                    const result = await response.json();
                    questionFormMessage.textContent = result.message;
                    questionFormMessage.className = response.ok ? 'text-green-400' : 'text-red-400';
                    if (response.ok) {
                        addQuestionForm.reset();
                        answersContainer.innerHTML = '';
                        stepsContainer.innerHTML = '';
                        addAnswerInput(answersContainer, true, '', true); // Reset to default two answers for MC
                        addAnswerInput(answersContainer, false, '', false);
                        addStepInput(stepsContainer, '', true); // Reset to one step
                        document.querySelector('input[name="question-type"][value="MultipleChoice"]').checked = true;
                        document.querySelector('input[name="question-type"][value="MultipleChoice"]').dispatchEvent(new Event('change')); // Trigger change to reset required fields
                        difficultyRatingSelect.value = '3';
                        fetchAndDisplayQuestions();
                    }
                } catch (error) {
                    console.error("Add question fetch error:", error);
                    questionFormMessage.textContent = "Server connection error.";
                    questionFormMessage.className = 'text-red-400';
                }
            });

            let questionsHash = null;
            let allQuestions = [];
            const fetchAndDisplayQuestions = async () => {
                const showLoading = questionsHash === null;
                if (showLoading) {
                    existingQuestionsList.innerHTML = '<p class="text-center text-gray-400">Loading questions...</p>';
                }
                try {
                    const response = await fetch('/api/admin/questions');
                    if (!response.ok) throw new Error('Failed to fetch questions');
                    const questions = await response.json();
                    const newHash = JSON.stringify(questions);
                    if (newHash === questionsHash) return; // skip update if unchanged
                    questionsHash = newHash;
                    allQuestions = Array.isArray(questions) ? questions : [];
                    applyQuestionFilter();
                } catch (error) {
                    console.error("Fetch questions for display error:", error);
                    existingQuestionsList.innerHTML = `<p class="text-red-400">Error loading questions: ${error.message}</p>`;
                }
            };

            const renderQuestions = (list) => {
                existingQuestionsList.innerHTML = '';
                if (!list.length) {
                    existingQuestionsList.innerHTML = '<p class="text-center text-gray-400">No questions found.</p>';
                    return;
                }
                list.forEach(q => {
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'bg-slate-700/50 p-4 rounded-lg mb-3 flex justify-between items-start border border-slate-600';
                    questionDiv.innerHTML = `
                        <div class="flex-grow pr-4">
                            <p class="font-bold text-white text-lg">${q.QuestionName}</p>
                            <p class="text-sm text-gray-300">Type: <span class="font-semibold">${q.QuestionType}</span></p>
                            <p class="text-sm text-gray-400">Difficulty: <span class="font-semibold">${q.DifficultyRating}</span></p>
                            <p class="text-sm text-gray-400">Topic: ${q.TopicName} <span class="text-xs text-gray-500"> (Unit: ${q.UnitName})</span></p>
                        </div>
                        <div class="flex space-x-2 flex-shrink-0">
                            <button data-id="${q.ID}" class="edit-question-btn bg-blue-600 text-white font-semibold py-1 px-3 text-sm rounded-full hover:bg-blue-500">Edit</button>
                            <button data-id="${q.ID}" class="delete-question-btn bg-red-600 text-white font-semibold py-1 px-3 text-sm rounded-full hover:bg-red-500">Delete</button>
                        </div>`;
                    existingQuestionsList.appendChild(questionDiv);
                });
            };

            const applyQuestionFilter = () => {
                if (!questionFilterInput) return renderQuestions(allQuestions);
                const q = questionFilterInput.value.trim().toLowerCase();
                if (!q) return renderQuestions(allQuestions);
                const col = questionFilterColumn ? questionFilterColumn.value : 'all';
                let filtered;
                if (col === 'all') {
                    filtered = allQuestions.filter(item =>
                        item.QuestionName.toLowerCase().includes(q) ||
                        (item.QuestionType || '').toLowerCase().includes(q) ||
                        String(item.DifficultyRating).toLowerCase().includes(q) ||
                        (item.TopicName || '').toLowerCase().includes(q) ||
                        (item.UnitName || '').toLowerCase().includes(q)
                    );
                } else {
                    filtered = allQuestions.filter(item => {
                        const val = item[col] !== undefined && item[col] !== null ? String(item[col]).toLowerCase() : '';
                        return val.includes(q);
                    });
                }
                renderQuestions(filtered);
            };

            existingQuestionsList.addEventListener('click', async (event) => {
                if (event.target.classList.contains('delete-question-btn')) {
                    const questionId = event.target.dataset.id;
                    if (confirm(`Are you sure you want to delete this question (ID: ${questionId})? This action cannot be undone.`)) {
                        try {
                            const response = await fetch(`/api/admin/delete-question/${questionId}`, {
                                method: 'DELETE'
                            });
                            const result = await response.json();
                            adminMessageDiv.textContent = result.message;
                            adminMessageDiv.className = response.ok ? 'text-center text-green-400 font-bold text-lg mb-4 h-6' : 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                            if (response.ok) {
                                fetchAndDisplayQuestions();
                            }
                            setTimeout(() => { adminMessageDiv.textContent = ''; }, 5000);
                        } catch (error) {
                            console.error("Delete question fetch error:", error);
                            adminMessageDiv.textContent = 'A connection error occurred during deletion.';
                            adminMessageDiv.className = 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                            setTimeout(() => { adminMessageDiv.textContent = ''; }, 5000);
                        }
                    }
                } else if (event.target.classList.contains('edit-question-btn')) {
                    console.log("Edit button clicked!");
                    const questionId = event.target.dataset.id;
                    console.log("Question ID from button data-id:", questionId);
                    handleOpenEditQuestionModal(questionId);
                }
            });

            const editAnswerInput = (container, isCorrect = false, text = '', isFirst = false) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-3';
                div.innerHTML = `
                    <input type="radio" name="edit-correct-answer" class="h-5 w-5" ${isCorrect ? 'checked' : ''}>
                    <input type="text" name="edit_answer_text" class="edit-answer-text w-full bg-slate-700 p-2 rounded-lg" placeholder="Answer option" value="${text}" required>
                    ${!isFirst ? '<button type="button" class="remove-btn text-red-500 text-2xl">×</button>' : ''}
                `;
                container.appendChild(div);
                div.querySelector('.remove-btn')?.addEventListener('click', () => div.remove());
            };

            const editStepInput = (container, text = '', isFirst = false) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-3';
                div.innerHTML = `
                    <span class="text-gray-400">Step:</span>
                    <textarea name="edit_step_text" class="edit-step-text w-full bg-slate-700 p-2 rounded-lg" rows="3" placeholder="Solution step" required>${text}</textarea>
                    ${!isFirst ? '<button type="button" class="remove-btn text-red-500 text-2xl">×</button>' : ''}
                `;
                container.appendChild(div);
                div.querySelector('.remove-btn')?.addEventListener('click', () => div.remove());
            };

            editQuestionTypeRadios.forEach(radio => radio.addEventListener('change', (e) => {
                const isMC = e.target.value === 'MultipleChoice';
                editMultipleChoiceSection.classList.toggle('hidden', !isMC);
                editOpenEndedSection.classList.toggle('hidden', isMC);

                // Manage required/disabled attributes for edit modal
                if (isMC) {
                    editAnswersContainer.querySelectorAll('.edit-answer-text').forEach(input => input.setAttribute('required', ''));
                    editAnswersContainer.querySelectorAll('input[type="radio"]').forEach(input => input.setAttribute('required', ''));
                    document.getElementById('edit-open-ended-answer').removeAttribute('required');
                    document.getElementById('edit-open-ended-answer').setAttribute('disabled', 'true');
                } else {
                    document.getElementById('edit-open-ended-answer').setAttribute('required', '');
                    document.getElementById('edit-open-ended-answer').removeAttribute('disabled');
                    editAnswersContainer.querySelectorAll('.edit-answer-text').forEach(input => input.removeAttribute('required'));
                    editAnswersContainer.querySelectorAll('input[type="radio"]').forEach(input => input.removeAttribute('required'));
                }

                // Question text and steps are always required regardless of type
                editQuestionTextInput.setAttribute('required', '');
                editStepsContainer.querySelectorAll('.edit-step-text').forEach(input => input.setAttribute('required', ''));
            }));

            editAddAnswerBtn.addEventListener('click', () => editAnswerInput(editAnswersContainer));
            editAddStepBtn.addEventListener('click', () => editStepInput(editStepsContainer));

            editAnswersContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) { e.target.closest('.flex').remove(); }
            });
            editStepsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-btn')) { e.target.closest('.flex').remove(); }
            });

            const handleOpenEditQuestionModal = async (questionId) => {
                editQuestionFormMessage.textContent = 'Loading question...';
                editQuestionFormMessage.className = 'text-center text-amber-400 mb-4 h-5';
                showModal(editQuestionModal);

                try {
                    const response = await fetch(`/api/admin/question/${questionId}`);
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.message || 'Failed to fetch question details with unknown error.');
                    }
                    const questionData = await response.json();

                    editQuestionIdInput.value = questionData.ID;
                    editQuestionTextInput.value = questionData.QuestionName;
                    editDifficultyRatingSelect.value = questionData.DifficultyRating;

                    const qTypeRadio = document.querySelector(`input[name="edit-question-type"][value="${questionData.QuestionType}"]`);
                    if (qTypeRadio) {
                        qTypeRadio.checked = true;
                        qTypeRadio.dispatchEvent(new Event('change')); // Trigger change to adjust sections visibility and required attributes
                    }

                    editAnswersContainer.innerHTML = '';
                    if (questionData.QuestionType === 'MultipleChoice' && questionData.Answers.length > 0) {
                        questionData.Answers.forEach((ans, index) => editAnswerInput(editAnswersContainer, ans.IsCorrect, ans.AnswerName, index === 0));
                    } else if (questionData.QuestionType === 'OpenEnded' && questionData.Answers.length > 0) {
                        editOpenEndedSection.querySelector('#edit-open-ended-answer').value = questionData.Answers[0].AnswerName;
                    } else {
                        // Ensure at least two answer fields for MC, or one for Open-ended if data is missing
                        if (questionData.QuestionType === 'MultipleChoice') {
                            editAnswerInput(editAnswersContainer, true, '', true);
                            editAnswerInput(editAnswersContainer, false, '', false);
                        }
                    }

                    editStepsContainer.innerHTML = '';
                    if (questionData.Steps.length > 0) {
                        questionData.Steps.forEach((stepText, index) => editStepInput(editStepsContainer, stepText, index === 0));
                    } else {
                        editStepInput(editStepsContainer, '', true);
                    }

                    if (questionData.CurriculumType && hierarchicalTopics[questionData.CurriculumType]) {
                        editQuestionSelectors.curriculumSelect.value = questionData.CurriculumType;
                        editQuestionSelectors.curriculumSelect.dispatchEvent(new Event('change'));
                    }
                    if (questionData.UnitName && hierarchicalTopics[questionData.CurriculumType]?.[questionData.UnitName]) {
                        editQuestionSelectors.unitSelect.value = questionData.UnitName;
                        editQuestionSelectors.unitSelect.dispatchEvent(new Event('change'));
                    }
                    if (questionData.TopicID) {
                        editQuestionSelectors.topicSelect.value = questionData.TopicID;
                    }

                    editQuestionFormMessage.textContent = '';
                } catch (error) {
                    console.error("An error occurred in handleOpenEditQuestionModal (fetch/populate):", error);
                    editQuestionFormMessage.textContent = `Error loading question: ${error.message}`;
                    editQuestionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                    hideModal(editQuestionModal);
                }
            };

            editQuestionForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                editQuestionFormMessage.textContent = 'Saving changes...';
                editQuestionFormMessage.className = 'text-center text-amber-400 mb-4 h-5';

                const questionId = editQuestionIdInput.value;
                const topicId = editQuestionSelectors.topicSelect.value;
                const questionText = editQuestionTextInput.value;
                const questionType = document.querySelector('input[name="edit-question-type"]:checked').value;
                const editedDifficultyRating = editDifficultyRatingSelect.value; /* Renamed variable */
                let answers = [];
                let steps = [];

                if (!topicId) {
                    editQuestionFormMessage.textContent = 'Please select a topic.';
                    editQuestionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                    return;
                }
                if (!questionText) {
                    editQuestionFormMessage.textContent = 'Please enter the question text.';
                    editQuestionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                    return;
                }

                if (questionType === 'MultipleChoice') {
                    const mcAnswerInputs = editAnswersContainer.querySelectorAll('.flex');
                    if (mcAnswerInputs.length === 0) {
                        editQuestionFormMessage.textContent = 'Please add at least one answer option.';
                        editQuestionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                        return;
                    }
                    let hasCorrectAnswer = false;
                    mcAnswerInputs.forEach(div => {
                        const radio = div.querySelector('input[type="radio"]');
                        const textInput = div.querySelector('.edit-answer-text');
                        if (textInput.value) {
                            answers.push({ text: textInput.value, isCorrect: radio.checked });
                            if (radio.checked) hasCorrectAnswer = true;
                        }
                    });
                    if (!hasCorrectAnswer) {
                        editQuestionFormMessage.textContent = 'Please select a correct answer for multiple choice.';
                        editQuestionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                        return;
                    }
                    if (answers.length < 2) {
                        editQuestionFormMessage.textContent = 'Multiple choice questions need at least two answer options.';
                        editQuestionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                        return;
                    }
                } else { // OpenEnded
                    const openEndedAnswer = editOpenEndedSection.querySelector('#edit-open-ended-answer').value;
                    if (!openEndedAnswer) {
                        editQuestionFormMessage.textContent = 'Please provide a correct answer for open-ended questions.';
                        editQuestionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                        return;
                    }
                    answers.push({ text: openEndedAnswer, isCorrect: true });
                }

                steps = Array.from(editStepsContainer.querySelectorAll('.edit-step-text')).map(input => ({ text: input.value })).filter(step => step.text);
                if (steps.length === 0) {
                    editQuestionFormMessage.textContent = 'Please provide at least one solution step.';
                    editQuestionFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                    return;
                }

                const questionData = { questionId: parseInt(questionId), topicId: parseInt(topicId), questionText, questionType, answers, steps, difficultyRating: parseInt(editedDifficultyRating) }; /* Used renamed variable */

                try {
                    const response = await fetch(`/api/admin/edit-question/${questionId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(questionData)
                    });
                    const result = await response.json();
                    editQuestionFormMessage.textContent = result.message;
                    editQuestionFormMessage.className = response.ok ? 'text-center text-green-400 mb-4 h-5' : 'text-center text-red-400 mb-4 h-5';
                    if (response.ok) {
                        fetchAndDisplayQuestions();
                        setTimeout(() => { hideModal(editQuestionModal); }, 1500);
                    }
                } catch (error) {
                    console.error("Edit question submit fetch error:", error);
                    editQuestionFormMessage.textContent = "Server connection error during update.";
                    editQuestionFormMessage.className = 'text-red-400';
                }
            });


            let storiesHash = null;
            let allStories = [];
            const fetchAndDisplayStories = async () => {
                if (storiesHash === null) {
                    existingStoriesList.innerHTML = '<p class="text-center text-gray-400">Loading stories...</p>';
                }
                try {
                    const response = await fetch('/api/admin/stories');
                    if (!response.ok) throw new Error('Failed to fetch stories');
                    const stories = await response.json();
                    const newHash = JSON.stringify(stories);
                    if (newHash === storiesHash) return; // skip update if unchanged
                    storiesHash = newHash;
                    allStories = Array.isArray(stories) ? stories : [];
                    applyStoryFilter();
                } catch (error) {
                    console.error("Fetch stories for display error:", error);
                    existingStoriesList.innerHTML = `<p class="text-red-400">Error loading stories: ${error.message}</p>`;
                }
            };

            const renderStories = (list) => {
                existingStoriesList.innerHTML = '';
                if (!list.length) {
                    existingStoriesList.innerHTML = '<p class="text-center text-gray-400">No stories found.</p>';
                    return;
                }
                list.forEach(s => {
                    const storyDiv = document.createElement('div');
                    storyDiv.className = 'bg-slate-700/50 p-4 rounded-lg flex justify-between items-center';
                    storyDiv.innerHTML = `
                        <div>
                            <p class="font-bold text-white">Story for: ${s.TopicName}</p>
                            <p class="text-sm text-gray-400">Topic ID: ${s.TopicID}</p>
                            <p class="text-sm text-gray-400">Default Theme: ${s.DefaultTheme || 'None Set'}</p>
                        </div>
                        <div class="flex space-x-2 flex-shrink-0">
                            <button data-topic-id="${s.TopicID}" class="edit-story-btn bg-blue-600 text-white font-semibold py-1 px-3 text-sm rounded-full hover:bg-blue-500">Edit</button>
                            <button data-topic-id="${s.TopicID}" class="delete-story-btn bg-red-600 text-white font-semibold py-1 px-3 text-sm rounded-full hover:bg-red-500">Delete</button>
                        </div>`;
                    existingStoriesList.appendChild(storyDiv);
                });
            };

            const applyStoryFilter = () => {
                if (!storyFilterInput) return renderStories(allStories);
                const q = storyFilterInput.value.trim().toLowerCase();
                if (!q) return renderStories(allStories);
                const col = storyFilterColumn ? storyFilterColumn.value : 'all';
                let filtered;
                if (col === 'all') {
                    filtered = allStories.filter(it =>
                        String(it.TopicID).toLowerCase().includes(q) ||
                        (it.TopicName || '').toLowerCase().includes(q) ||
                        (it.DefaultTheme || '').toLowerCase().includes(q)
                    );
                } else {
                    filtered = allStories.filter(it => {
                        const val = it[col] !== undefined && it[col] !== null ? String(it[col]).toLowerCase() : '';
                        return val.includes(q);
                    });
                }
                renderStories(filtered);
            };

            existingStoriesList.addEventListener('click', async (event) => {
                if (event.target.classList.contains('delete-story-btn')) {
                    const topicId = event.target.dataset.topicId;
                    if (confirm(`Are you sure you want to delete the story for Topic ID: ${topicId}? This will remove all sections. This action cannot be undone.`)) {
                        try {
                            const response = await fetch(`/api/admin/delete-story/${topicId}`, {
                                method: 'DELETE'
                            });
                            const result = await response.json();
                            adminMessageDiv.textContent = result.message;
                            adminMessageDiv.className = response.ok ? 'text-center text-green-400 font-bold text-lg mb-4 h-6' : 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                            if (response.ok) {
                                fetchAndDisplayStories();
                            }
                            setTimeout(() => { adminMessageDiv.textContent = ''; }, 5000);
                        } catch (error) {
                            console.error("Delete story fetch error:", error);
                            adminMessageDiv.textContent = 'A connection error occurred during story deletion.';
                            adminMessageDiv.className = 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                            setTimeout(() => { adminMessageDiv.textContent = ''; }, 5000);
                        }
                    }
                } else if (event.target.classList.contains('edit-story-btn')) {
                    const topicId = event.target.dataset.topicId;
                    handleOpenEditStory(topicId);
                }
            });

            const renderInteractiveConfigUI = (contentContainer, elementType, configData = {}) => {
                let configHtml = '';
                contentContainer.innerHTML = '';

                switch (elementType) {
                    case 'FractionBuilder':
                        const defaultNumerator = configData.numerator || 1;
                        const defaultDenominator = configData.denominator || 2;
                        const defaultWhole = configData.whole || 0;
                        configHtml = `
                            <div class="space-y-2">
                                <label class="block text-gray-400 text-sm font-semibold">Initial Fraction:</label>
                                <div class="flex items-center space-x-2">
                                    <input type="number" class="fraction-whole-input w-20 bg-slate-600 p-2 rounded-md" placeholder="Whole" value="${defaultWhole}">
                                    <span class="text-xl font-bold">+</span>
                                    <input type="number" class="fraction-numerator-input w-20 bg-slate-600 p-2 rounded-md" placeholder="Num" value="${defaultNumerator}">
                                    <span class="text-xl font-bold">/</span>
                                    <input type="number" class="fraction-denominator-input w-20 bg-slate-600 p-2 rounded-md" placeholder="Den" value="${defaultDenominator}">
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Set the initial whole number, numerator, and denominator.</p>
                            </div>
                        `;
                        break;
                    case 'EquationBalancer':
                        const defaultEquation = configData.equation || '2x + 5 = 15';
                        configHtml = `
                            <div class="space-y-2">
                                <label class="block text-gray-400 text-sm font-semibold">Equation Text:</label>
                                <input type="text" class="equation-text-input w-full bg-slate-600 p-2 rounded-md" placeholder="e.g., 2x + 5 = 15" value="${defaultEquation}">
                                <p class="text-xs text-gray-500 mt-1">Enter the equation for the balancer.</p>
                            </div>
                        `;
                        break;
                    case 'ShapeManipulator':
                        const defaultShape = configData.shape || 'square';
                        const defaultSize = configData.size || 100;
                        configHtml = `
                            <div class="space-y-2">
                                <label class="block text-gray-400 text-sm font-semibold">Shape Type:</label>
                                <select class="shape-type-selector bg-slate-600 p-2 rounded-lg w-full">
                                    <option value="square" ${defaultShape === 'square' ? 'selected' : ''}>Square</option>
                                    <option value="circle" ${defaultShape === 'circle' ? 'selected' : ''}>Circle</option>
                                    <option value="triangle" ${defaultShape === 'triangle' ? 'selected' : ''}>Triangle</option>
                                </select>
                                <label class="block text-gray-400 text-sm font-semibold mt-3">Initial Size (px):</label>
                                <input type="number" class="shape-size-input w-full bg-slate-600 p-2 rounded-md" placeholder="e.g., 100" value="${defaultSize}">
                                <p class="text-xs text-gray-500 mt-1">Set the initial shape and its size.</p>
                            </div>
                        `;
                        break;
                    default:
                        configHtml = `
                            <p class="text-gray-500">Select an interactive type to configure it.</p>
                        `;
                        break;
                }
                contentContainer.innerHTML = configHtml;
            };


            const handleOpenEditStory = async (topicId) => {
                storyFormMessage.textContent = 'Loading story for editing...';
                storyFormMessage.className = 'text-center text-amber-400 mb-4 h-5';

                storiesTabBtn.click(); // Switch to stories tab

                try {
                    const response = await fetch(`/api/story/${topicId}`);
                    if (!response.ok) {
                        const errorResult = await response.json();
                        throw new Error(errorResult.message || 'Failed to fetch story details.');
                    }
                    const storyResponseData = await response.json(); // This now contains sections, defaultTheme, availableThemes
                    const storySections = storyResponseData.sections;
                    const defaultTheme = storyResponseData.defaultTheme;
                    const availableThemes = storyResponseData.availableThemes;

                    storyBuilderContainer.innerHTML = ''; // Clear existing sections

                    // Populate the theme dropdown
                    storyThemeSelect.innerHTML = '<option value="">-- Select Theme --</option>';
                    // Assuming you have a fixed set of themes, or you'd fetch them
                    const allPossibleThemes = ['Detective', 'Fantasy', 'Indian Epics']; // Hardcoded for now, but could be dynamic
                    allPossibleThemes.forEach(theme => {
                        const option = document.createElement('option');
                        option.value = theme;
                        option.textContent = theme;
                        storyThemeSelect.appendChild(option);
                    });
                    if (defaultTheme) {
                        storyThemeSelect.value = defaultTheme;
                    }


                    let foundCurriculum = null;
                    let foundUnit = null;
                    for (const curr in hierarchicalTopics) {
                        for (const unit in hierarchicalTopics[curr]) {
                            const topic = hierarchicalTopics[curr][unit].find(t => t.id == topicId);
                            if (topic) {
                                foundCurriculum = curr;
                                foundUnit = unit;
                                break;
                            }
                        }
                        if (foundCurriculum) break;
                    }

                    if (foundCurriculum) {
                        storySelectors.curriculumSelect.value = foundCurriculum;
                        storySelectors.curriculumSelect.dispatchEvent(new Event('change'));
                    }
                    if (foundUnit) {
                        storySelectors.unitSelect.value = foundUnit;
                        storySelectors.unitSelect.dispatchEvent(new Event('change'));
                    }
                    if (topicId) {
                        storySelectors.topicSelect.value = topicId;
                    }
                    storySelectors.topicSelect.disabled = false;


                    storySections.forEach(section => {
                        const div = document.createElement('div');
                        div.className = 'story-section bg-slate-800 p-4 rounded-lg space-y-3';

                        let contentHtml = '';
                        if (section.contentType === 'Paragraph') {
                            contentHtml = `
                                <div class="paragraph-content">
                                    <textarea class="w-full bg-slate-700/80 p-2 rounded-md" rows="4" placeholder="Type paragraph content here...">${section.content}</textarea>
                                </div>
                            `;
                        } else if (section.contentType === 'Interactive') {
                            contentHtml = `
                                <div class="interactive-content space-y-3">
                                    <label class="block text-gray-400 text-sm font-semibold">Element Type:</label>
                                    <select class="element-type-selector bg-slate-600 p-2 rounded-lg w-full">
                                        <option value="">-- Select Interactive Type --</option>
                                        <option value="FractionBuilder">Fraction Builder</option>
                                        <option value="EquationBalancer">Equation Balancer</option>
                                        <option value="ShapeManipulator">Shape Manipulator</option>
                                    </select>
                                    <div class="interactive-config-area">
                                        </div>
                                </div>
                            `;
                        }

                        div.innerHTML = `
                            <div class="flex items-center justify-between">
                                <input type="text" class="section-name-input bg-slate-700 p-2 rounded-lg font-bold text-white w-1/2" placeholder="Section Name (e.g., Hook)" value="${section.sectionName}">
                                <select class="content-type-selector bg-slate-700 p-2 rounded-lg">
                                    <option value="Paragraph" ${section.contentType === 'Paragraph' ? 'selected' : ''}>Paragraph</option>
                                    <option value="Interactive" ${section.contentType === 'Interactive' ? 'selected' : ''}>Interactive Element</option>
                                </select>
                                <button class="remove-section-btn text-red-500 font-bold text-2xl">×</button>
                            </div>
                            <div class="content-container">
                                ${contentHtml}
                            </div>
                        `;
                        storyBuilderContainer.appendChild(div);

                        const contentTypeSelector = div.querySelector('.content-type-selector');
                        if (contentTypeSelector) {
                            contentTypeSelector.dispatchEvent(new Event('change'));
                        }

                        if (section.contentType === 'Interactive') {
                            const elementTypeSelector = div.querySelector('.element-type-selector');
                            const interactiveConfigArea = div.querySelector('.interactive-config-area');
                            if (elementTypeSelector && interactiveConfigArea) {
                                elementTypeSelector.value = section.content.elementType;
                                renderInteractiveConfigUI(interactiveConfigArea, section.content.elementType, section.content.configuration);
                            }
                        }
                    });

                    storyFormMessage.textContent = 'Story loaded for editing.';
                    storyFormMessage.className = 'text-center text-green-400 mb-4 h-5';

                } catch (error) {
                    console.error("Error loading story for edit:", error);
                    storyFormMessage.textContent = `Error loading story: ${error.message}`;
                    storyFormMessage.className = 'text-center text-red-400 mb-4 h-5';
                    storyBuilderContainer.innerHTML = '<p class="text-center text-gray-500">Add sections to build your story.</p>';
                }
            };


            const addSectionToBuilder = () => {
                const sectionId = `section-${Date.now()}`;
                const div = document.createElement('div');
                div.className = 'story-section bg-slate-800 p-4 rounded-lg space-y-3';
                div.innerHTML = `
                    <div class="flex items-center justify-between">
                        <input type="text" class="section-name-input bg-slate-700 p-2 rounded-lg font-bold text-white w-1/2" placeholder="Section Name (e.g., Hook)">
                        <select class="content-type-selector bg-slate-700 p-2 rounded-lg">
                            <option value="Paragraph">Paragraph</option>
                            <option value="Interactive">Interactive Element</option>
                        </select>
                        <button class="remove-section-btn text-red-500 font-bold text-2xl">×</button>
                    </div>
                    <div class="content-container">
                        <div class="paragraph-content">
                            <textarea class="w-full bg-slate-700/80 p-2 rounded-md" rows="4" placeholder="Type paragraph content here..."></textarea>
                        </div>
                        <div class="interactive-content hidden space-y-3">
                            <label class="block text-gray-400 text-sm font-semibold">Element Type:</label>
                            <select class="element-type-selector bg-slate-600 p-2 rounded-lg w-full">
                                <option value="">-- Select Interactive Type --</option>
                                <option value="FractionBuilder">Fraction Builder</option>
                                <option value="EquationBalancer">Equation Balancer</option>
                                <option value="ShapeManipulator">Shape Manipulator</option>
                            </select>
                            <div class="interactive-config-area">
                                <p class="text-gray-500">Select an interactive type to configure it.</p>
                            </div>
                        </div>
                    </div>
                `;
                const placeholder = storyBuilderContainer.querySelector('p');
                if (placeholder) placeholder.remove();
                storyBuilderContainer.appendChild(div);

                const contentTypeSelector = div.querySelector('.content-type-selector');
                if (contentTypeSelector) {
                    // Manually trigger change to ensure correct initial state of content areas
                    contentTypeSelector.value = "Paragraph"; // Default to Paragraph
                    contentTypeSelector.dispatchEvent(new Event('change'));
                }
            };

            storyBuilderContainer.addEventListener('click', e => {
                if (e.target.classList.contains('remove-section-btn')) { e.target.closest('.story-section').remove(); return; }
            });

            storyBuilderContainer.addEventListener('change', e => {
                if (e.target.classList.contains('content-type-selector')) {
                    const section = e.target.closest('.story-section');
                    const isParagraph = e.target.value === 'Paragraph';
                    const isInteractive = e.target.value === 'Interactive';

                    section.querySelector('.paragraph-content').classList.toggle('hidden', !isParagraph);
                    section.querySelector('.interactive-content').classList.toggle('hidden', !isInteractive);

                    // Crucially, manage required state based on visibility
                    const paragraphTextarea = section.querySelector('.paragraph-content textarea');
                    const interactiveElementTypeSelector = section.querySelector('.interactive-content .element-type-selector');

                    if (isParagraph) {
                        paragraphTextarea.setAttribute('required', '');
                        interactiveElementTypeSelector.removeAttribute('required'); // Remove required from interactive type when hidden
                    } else if (isInteractive) {
                        paragraphTextarea.removeAttribute('required');
                        interactiveElementTypeSelector.setAttribute('required', ''); // Set required for interactive type when visible
                        // Ensure interactive config inputs are also managed as required when selected
                        const interactiveConfigArea = section.querySelector('.interactive-config-area');
                        const interactiveInputs = interactiveConfigArea.querySelectorAll('input, select');
                        interactiveInputs.forEach(input => input.setAttribute('required', ''));
                    }

                    if (isInteractive) {
                        const elementTypeSelector = section.querySelector('.element-type-selector');
                        const interactiveConfigArea = section.querySelector('.interactive-config-area');
                        if (elementTypeSelector && interactiveConfigArea) {
                            // If switching to interactive, clear previous selection if any and re-render default config UI
                            elementTypeSelector.value = "";
                            renderInteractiveConfigUI(interactiveConfigArea, "");
                        }
                    }
                } else if (e.target.classList.contains('element-type-selector')) {
                    const section = e.target.closest('.story-section');
                    const elementType = e.target.value;
                    const interactiveConfigArea = section.querySelector('.interactive-config-area');
                    if (interactiveConfigArea) {
                        renderInteractiveConfigUI(interactiveConfigArea, elementType);
                        // Make inputs within the newly rendered config area required
                        const configInputs = interactiveConfigArea.querySelectorAll('input, select');
                        configInputs.forEach(input => input.setAttribute('required', ''));
                    }
                }
            });


            saveStoryBtn.addEventListener('click', async () => {
                storyFormMessage.textContent = 'Saving...';
                storyFormMessage.className = 'text-amber-400';
                const topicId = storySelectors.topicSelect.value;
                const defaultTheme = storyThemeSelect.value; // NEW: Get selected theme

                if (!topicId) { storyFormMessage.textContent = "Select a topic first."; storyFormMessage.className = 'text-red-400'; return; }
                if (!defaultTheme) { storyFormMessage.textContent = "Please select a default theme."; storyFormMessage.className = 'text-red-400'; return; }


                const storySectionsPayload = [];
                const sectionElements = storyBuilderContainer.querySelectorAll('.story-section');

                for (const sectionEl of sectionElements) {
                    const sectionName = sectionEl.querySelector('.section-name-input').value;
                    const contentType = sectionEl.querySelector('.content-type-selector').value;
                    if (!sectionName) { storyFormMessage.textContent = `A section is missing its name.`; storyFormMessage.className = 'text-red-400'; return; }

                    let contentPayload;
                    if (contentType === 'Paragraph') {
                        contentPayload = sectionEl.querySelector('.paragraph-content textarea').value;
                        if (!contentPayload) { storyFormMessage.textContent = `Section "${sectionName}" has no paragraph text.`; storyFormMessage.className = 'text-red-400'; return; }
                    } else if (contentType === 'Interactive') {
                        const elementType = sectionEl.querySelector('.element-type-selector').value;
                        let configuration = {};

                        const interactiveConfigArea = sectionEl.querySelector('.interactive-config-area');
                        switch (elementType) {
                            case 'FractionBuilder':
                                const whole = parseInt(interactiveConfigArea.querySelector('.fraction-whole-input').value);
                                const numerator = parseInt(interactiveConfigArea.querySelector('.fraction-numerator-input').value);
                                const denominator = parseInt(interactiveConfigArea.querySelector('.fraction-denominator-input').value);

                                if (isNaN(whole) || isNaN(numerator) || isNaN(denominator) || denominator === 0) {
                                    storyFormMessage.textContent = `Section "${sectionName}" (Fraction Builder) has invalid numbers.`;
                                    storyFormMessage.className = 'text-red-400';
                                    return;
                                }
                                configuration = { whole, numerator, denominator };
                                break;
                            case 'EquationBalancer':
                                const equationText = interactiveConfigArea.querySelector('.equation-text-input').value;
                                if (!equationText) {
                                    storyFormMessage.textContent = `Section "${sectionName}" (Equation Balancer) needs an equation.`;
                                    storyFormMessage.className = 'text-red-400';
                                    return;
                                }
                                configuration = { equation: equationText };
                                break;
                            case 'ShapeManipulator':
                                const shapeType = interactiveConfigArea.querySelector('.shape-type-selector').value;
                                const shapeSize = parseInt(interactiveConfigArea.querySelector('.shape-size-input').value);
                                if (!shapeType || isNaN(shapeSize) || shapeSize <= 0) {
                                    storyFormMessage.textContent = `Section "${sectionName}" (Shape Manipulator) has invalid shape or size.`;
                                    storyFormMessage.className = 'text-red-400';
                                    return;
                                }
                                configuration = { shape: shapeType, size: shapeSize };
                                break;
                            default:
                                storyFormMessage.textContent = `Section "${sectionName}" has an unconfigured interactive element type.`;
                                storyFormMessage.className = 'text-red-400';
                                return;
                        }

                        if (!elementType) {
                            storyFormMessage.textContent = `Section "${sectionName}" has no interactive element type selected.`;
                            storyFormMessage.className = 'text-red-400';
                            return;
                        }

                        contentPayload = { elementType, configuration };
                    }

                    storySectionsPayload.push({ sectionName, contentType, content: contentPayload });
                }

                try {
                    const response = await fetch('/api/admin/save-story', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ topicId, storySections: storySectionsPayload, defaultTheme: defaultTheme }) // NEW: Include defaultTheme
                    });
                    const result = await response.json();
                    storyFormMessage.textContent = result.message;
                    storyFormMessage.className = response.ok ? 'text-green-400' : 'text-red-400';
                    if (response.ok) {
                        storyBuilderContainer.innerHTML = '<p class="text-center text-gray-500">Add sections to build your story.</p>';
                        storyThemeSelect.value = ''; // Reset theme selection
                        fetchAndDisplayStories();
                    }
                } catch(error) {
                    console.error("Save story fetch error:", error);
                    storyFormMessage.textContent = "Server connection error.";
                    storyFormMessage.className = 'text-red-400';
                }
            });

            let flagsHash = null;
            let allFlags = [];
            const fetchAndDisplayFlaggedItems = async () => {
                if (flagsHash === null) {
                    flaggedItemsList.innerHTML = '<p class="text-center text-gray-400">Loading flagged items...</p>';
                }
                try {
                    const response = await fetch('/api/admin/flagged-items');
                    if (!response.ok) throw new Error('Failed to fetch flagged items');
                    const flags = await response.json();
                    const newHash = JSON.stringify(flags);
                    if (newHash === flagsHash) return; // skip update if unchanged
                    flagsHash = newHash;
                    allFlags = Array.isArray(flags) ? flags : [];
                    applyFlagFilter();
                } catch (error) {
                    console.error("Fetch flagged items error:", error);
                    flaggedItemsList.innerHTML = `<p class="text-red-400">Error loading flagged items: ${error.message}</p>`;
                }
            };

            const renderFlags = (items) => {
                flaggedItemsList.innerHTML = '';
                if (!items.length) {
                    flaggedItemsList.innerHTML = '<p class="text-center text-gray-400">No flagged items found.</p>';
                    return;
                }
                items.forEach(flag => {
                    const flagDiv = document.createElement('div');
                    flagDiv.className = `bg-slate-700/50 p-4 rounded-lg mb-3 border border-slate-600 flex flex-col sm:flex-row justify-between items-start sm:items-center`;
                    flagDiv.innerHTML = `
                        <div class="flex-grow pr-4 mb-2 sm:mb-0">
                            <p class="font-bold text-white">${flag.ItemType} Flag: <span class="text-amber-300">${flag.ItemName || 'ID: ' + flag.FlagID}</span></p>
                            <p class="text-sm text-gray-300">Reported by: ${flag.ReporterUsername || 'Anonymous'} on ${new Date(flag.ReportedOn).toLocaleString()}</p>
                            <p class="text-red-300 font-bold text-lg text-center my-2">${flag.Reason || 'No reason provided.'}</p>
                            <p class="text-sm text-gray-400">Status: <span class="px-2 py-0.5 rounded-full text-xs font-semibold status-${flag.Status}">${flag.Status}</span></p>
                            ${flag.ResolvedOn ? `<p class="text-xs text-gray-500 mt-1">Resolved by: ${flag.ResolvedByUsername || 'N/A'} on ${new Date(flag.ResolvedOn).toLocaleString()}</p>` : ''}
                        </div>
                        <div class="flex space-x-2 flex-shrink-0">
                            <button data-flag-id="${flag.FlagID}" data-status="Reviewed" class="resolve-flag-btn bg-green-600 text-white font-semibold py-1 px-3 text-sm rounded-full hover:bg-green-500 ${flag.Status !== 'Pending' ? 'opacity-50 cursor-not-allowed' : ''}" ${flag.Status !== 'Pending' ? 'disabled' : ''}>Mark Reviewed</button>
                            <button data-flag-id="${flag.FlagID}" data-status="Dismissed" class="resolve-flag-btn bg-gray-600 text-white font-semibold py-1 px-3 text-sm rounded-full hover:bg-gray-500 ${flag.Status !== 'Pending' ? 'opacity-50 cursor-not-allowed' : ''}" ${flag.Status !== 'Pending' ? 'disabled' : ''}>Dismiss</button>
                            <button data-flag-id="${flag.FlagID}" data-status="Pending" class="resolve-flag-btn reopen-flag-btn bg-blue-600 text-white font-semibold py-1 px-3 text-sm rounded-full hover:bg-blue-500 ${flag.Status === 'Pending' ? 'hidden' : ''}">Reopen</button>
                            <button data-flag-id="${flag.FlagID}" class="delete-flag-btn bg-red-600 text-white font-semibold py-1 px-3 text-sm rounded-full hover:bg-red-500">Delete</button>
                        </div>`;
                    flaggedItemsList.appendChild(flagDiv);
                });
            };

            const applyFlagFilter = () => {
                if (!flagFilterInput) return renderFlags(allFlags);
                const q = flagFilterInput.value.trim().toLowerCase();
                if (!q) return renderFlags(allFlags);
                const col = flagFilterColumn ? flagFilterColumn.value : 'all';
                let filtered;
                if (col === 'all') {
                    filtered = allFlags.filter(f =>
                        String(f.FlagID).toLowerCase().includes(q) ||
                        (f.ItemType || '').toLowerCase().includes(q) ||
                        (f.ItemName || '').toLowerCase().includes(q) ||
                        (f.ReporterUsername || '').toLowerCase().includes(q) ||
                        (f.Status || '').toLowerCase().includes(q)
                    );
                } else {
                    filtered = allFlags.filter(f => {
                        const val = f[col] !== undefined && f[col] !== null ? String(f[col]).toLowerCase() : '';
                        return val.includes(q);
                    });
                }
                renderFlags(filtered);
            };

            flaggedItemsList.addEventListener('click', async (event) => {
                const target = event.target;
                if (target.classList.contains('resolve-flag-btn')) {
                    const flagId = target.dataset.flagId;
                    const newStatus = target.dataset.status;
                    if (confirm(`Are you sure you want to change status of flag ${flagId} to "${newStatus}"?`)) {
                        try {
                            const response = await fetch(`/api/admin/update-flag-status/${flagId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ status: newStatus, adminId: parseInt(adminId) })
                            });
                            const result = await response.json();
                            adminMessageDiv.textContent = result.message;
                            adminMessageDiv.className = response.ok ? 'text-center text-green-400 font-bold text-lg mb-4 h-6' : 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                            if (response.ok) {
                                fetchAndDisplayFlaggedItems();
                            }
                            setTimeout(() => { adminMessageDiv.textContent = ''; }, 5000);
                        } catch (error) {
                            console.error("Update flag status error:", error);
                            adminMessageDiv.textContent = 'A connection error occurred during status update.';
                            adminMessageDiv.className = 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                            setTimeout(() => { adminMessageDiv.textContent = ''; }, 5000);
                        }
                    }
                } else if (target.classList.contains('delete-flag-btn')) {
                    const flagId = target.dataset.flagId;
                    if (confirm(`Delete flag ${flagId}?`)) {
                        try {
                            const response = await fetch(`/api/admin/delete-flag/${flagId}`, { method: 'DELETE' });
                            const result = await response.json();
                            adminMessageDiv.textContent = result.message;
                            adminMessageDiv.className = response.ok ? 'text-center text-green-400 font-bold text-lg mb-4 h-6' : 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                            if (response.ok) {
                                fetchAndDisplayFlaggedItems();
                            }
                            setTimeout(() => { adminMessageDiv.textContent = ''; }, 5000);
                        } catch (error) {
                            console.error('Delete flag error:', error);
                            adminMessageDiv.textContent = 'A connection error occurred during deletion.';
                            adminMessageDiv.className = 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                            setTimeout(() => { adminMessageDiv.textContent = ''; }, 5000);
                        }
                    }
                }
            });

            // NEW: Fetch and Display Question Attempts
            let attemptsHash = null;
            let allAttempts = [];
            const fetchAndDisplayQuestionAttempts = async () => {
                if (attemptsHash === null) {
                    attemptsTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-400">Loading attempts...</td></tr>'; // Adjusted colspan
                }
                try {
                    const response = await fetch('/api/admin/question-attempts');
                    if (!response.ok) throw new Error('Failed to fetch question attempts');
                    const attempts = await response.json();
                    const newHash = JSON.stringify(attempts);
                    if (newHash === attemptsHash) return; // skip update if unchanged
                    attemptsHash = newHash;
                    allAttempts = Array.isArray(attempts) ? attempts : [];
                    applyAttemptFilter();
                } catch (error) {
                    console.error("Fetch question attempts error:", error);
                    attemptsTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-400">Error loading attempts: ${error.message}</td></tr>`; // Adjusted colspan
                }
            };

            const renderAttempts = (arr) => {
                attemptsTableBody.innerHTML = '';
                if (!arr.length) {
                    attemptsTableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4 text-gray-400">No question attempts recorded yet.</td></tr>';
                    return;
                }
                arr.forEach(attempt => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-slate-700 hover:bg-slate-700/50';
                    const isCorrectClass = attempt.IsCorrect ? 'attempt-correct' : 'attempt-incorrect';
                    const isCorrectText = attempt.IsCorrect ? 'Yes' : 'No';

                    row.innerHTML = `
                        <td class="px-6 py-4">${attempt.AttemptID}</td>
                        <td class="px-6 py-4">${new Date(attempt.AttemptTime).toLocaleString()}</td>
                        <td class="px-6 py-4">${attempt.AttemptingUsername}</td>
                        <td class="px-6 py-4">${attempt.QuestionText}</td>
                        <td class="px-6 py-4">${attempt.UserAnswer || 'N/A'}</td>
                        <td class="px-6 py-4 font-bold ${isCorrectClass}">${isCorrectText}</td>
                        <td class="px-6 py-4">${attempt.CorrectAnswer || 'N/A'}</td> <td class="px-6 py-4">${attempt.DifficultyAtAttempt}</td>
                        <td class="px-6 py-4">${attempt.TopicName} (${attempt.UnitName})</td>`;
                    attemptsTableBody.appendChild(row);
                });
            };

            const applyAttemptFilter = () => {
                if (!attemptFilterInput) return renderAttempts(allAttempts);
                const q = attemptFilterInput.value.trim().toLowerCase();
                if (!q) return renderAttempts(allAttempts);
                const col = attemptFilterColumn ? attemptFilterColumn.value : 'all';
                let filtered;
                if (col === 'all') {
                    filtered = allAttempts.filter(a =>
                        String(a.AttemptID).toLowerCase().includes(q) ||
                        (a.AttemptingUsername || '').toLowerCase().includes(q) ||
                        (a.QuestionText || '').toLowerCase().includes(q) ||
                        String(a.IsCorrect).toLowerCase().includes(q) ||
                        (a.TopicName || '').toLowerCase().includes(q)
                    );
                } else {
                    filtered = allAttempts.filter(a => {
                        const val = a[col] !== undefined && a[col] !== null ? String(a[col]).toLowerCase() : '';
                        return val.includes(q);
                    });
                }
                renderAttempts(filtered);
            };

            let curriculumsHash = null;
            let allCurriculums = [];
            const fetchAndDisplayCurriculums = async () => {
                if (curriculumsHash === null) {
                    existingCurriculumsList.innerHTML = '<p class="text-center text-gray-400">Loading curriculums...</p>';
                }
                try {
                    const response = await fetch('/api/admin/curriculums');
                    if (!response.ok) throw new Error('Failed to fetch curriculums');
                    const curriculums = await response.json();
                    if (!Array.isArray(curriculums)) {
                        existingCurriculumsList.innerHTML = `<p class="text-red-400">${curriculums.message || 'Error loading curriculums'}</p>`;
                        return;
                    }
                    const newHash = JSON.stringify(curriculums);
                    if (newHash === curriculumsHash) return;
                    curriculumsHash = newHash;
                    allCurriculums = curriculums;
                    renderCurriculums(allCurriculums);
                } catch (error) {
                    console.error('Fetch curriculums error:', error);
                    existingCurriculumsList.innerHTML = `<p class="text-red-400">Error loading curriculums: ${error.message}</p>`;
                }
            };

            const renderCurriculums = (list) => {
                existingCurriculumsList.innerHTML = '';
                if (!list.length) {
                    existingCurriculumsList.innerHTML = '<p class="text-center text-gray-400">No curriculums found.</p>';
                    return;
                }
                list.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'bg-slate-700/50 p-4 rounded-lg mb-4';
                    const header = document.createElement('div');
                    header.className = 'flex justify-between items-center';
                    header.innerHTML = `<span class="font-bold text-white">${c.subjectname}</span>
                        <div class="space-x-2">
                            <button data-id="${c.id}" class="edit-curriculum-btn bg-blue-600 text-white font-semibold py-1 px-3 text-sm rounded-full hover:bg-blue-500">Edit</button>
                            <button data-id="${c.id}" class="delete-curriculum-btn bg-red-600 text-white font-semibold py-1 px-3 text-sm rounded-full hover:bg-red-500">Delete</button>
                        </div>`;
                    div.appendChild(header);

                    const units = hierarchicalTopics[c.subjectname] || {};
                    const unitsList = document.createElement('ul');
                    unitsList.className = 'ml-4 mt-2 space-y-1 text-gray-300';
                    Object.keys(units).sort().forEach(u => {
                        const unitLi = document.createElement('li');
                        unitLi.innerHTML = `<span class="font-semibold">${u}</span>`;
                        const topicsUl = document.createElement('ul');
                        topicsUl.className = 'ml-6 list-disc';
                        units[u].forEach(t => {
                            const topicLi = document.createElement('li');
                            topicLi.textContent = t.name;
                            topicsUl.appendChild(topicLi);
                        });
                        unitLi.appendChild(topicsUl);
                        unitsList.appendChild(unitLi);
                    });
                    if (unitsList.children.length > 0) {
                        div.appendChild(unitsList);
                    }
                existingCurriculumsList.appendChild(div);
            });
        };

            const fetchCurriculumTable = async () => {
                curriculumTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">Loading...</td></tr>';
                try {
                    const resp = await fetch('/api/curriculum-table');
                    if (!resp.ok) throw new Error('Failed to fetch curriculum table');
                    const rows = await resp.json();
                    if (!Array.isArray(rows) || rows.length === 0) {
                        curriculumTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-gray-400">No data found.</td></tr>';
                        return;
                    }
                    curriculumTableBody.innerHTML = '';
                    rows.forEach(r => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td class="px-4 py-2">${r.gradename}</td>` +
                            `<td class="px-4 py-2">${r.curriculumtype}</td>` +
                            `<td class="px-4 py-2">${r.unitname}</td>` +
                            `<td class="px-4 py-2">${r.topicname}</td>`;
                        curriculumTableBody.appendChild(tr);
                    });
                } catch (err) {
                    curriculumTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-red-400">Error: ${err.message}</td></tr>`;
                }
            };

            existingCurriculumsList.addEventListener('click', async (e) => {
                if (e.target.classList.contains('edit-curriculum-btn')) {
                    const id = e.target.dataset.id;
                    const curr = allCurriculums.find(c => c.id == id);
                    if (!curr) return;
                    editCurriculumIdInput.value = curr.id;
                    editCurriculumNameInput.value = curr.subjectname;
                    editCurriculumMessage.textContent = '';
                    showModal(editCurriculumModal);
                } else if (e.target.classList.contains('delete-curriculum-btn')) {
                    const id = e.target.dataset.id;
                    if (!confirm('Are you sure you want to delete this curriculum?')) return;
                    try {
                        const resp = await fetch(`/api/admin/delete-curriculum/${id}`, { method: 'DELETE' });
                        const result = await resp.json();
                        adminMessageDiv.textContent = result.message;
                        if (resp.ok) {
                            adminMessageDiv.className = 'text-center text-green-400 font-bold text-lg mb-4 h-6';
                            await loadCurriculums();
                            await initializeTopicData();
                            fetchAndDisplayCurriculums();
                            fetchCurriculumTable();
                        } else {
                            adminMessageDiv.className = 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                        }
                    } catch (error) {
                        adminMessageDiv.textContent = 'Server connection error.';
                        adminMessageDiv.className = 'text-center text-red-400 font-bold text-lg mb-4 h-6';
                    }
                    setTimeout(() => { adminMessageDiv.textContent = ''; }, 5000);
                }
            });

            editCurriculumForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = editCurriculumIdInput.value;
                const name = editCurriculumNameInput.value.trim();
                if (!name) return;
                try {
                    const resp = await fetch(`/api/admin/update-curriculum/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    const result = await resp.json();
                    editCurriculumMessage.textContent = result.message;
                    editCurriculumMessage.className = resp.ok ? 'text-green-400' : 'text-red-400';
                    if (resp.ok) {
                        fetchAndDisplayCurriculums();
                        setTimeout(() => hideModal(editCurriculumModal), 1500);
                    }
                } catch (error) {
                    editCurriculumMessage.textContent = 'Server connection error.';
                    editCurriculumMessage.className = 'text-red-400';
                }
            });

            seedDatabaseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!seedFileInput.files.length) return;
                const formData = new FormData();
                formData.append('file', seedFileInput.files[0]);
                try {
                    const resp = await fetch('/api/admin/seed-database', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await resp.json();
                    seedDatabaseMessage.textContent = result.message;
                    seedDatabaseMessage.className = resp.ok ? 'text-center text-green-400 mt-4 h-5' : 'text-center text-red-400 mt-4 h-5';
                    if (resp.ok) {
                        await loadCurriculums();
                        await initializeTopicData();
                        fetchAndDisplayCurriculums();
                        fetchCurriculumTable();
                    }
                } catch (error) {
                    seedDatabaseMessage.textContent = 'Server connection error.';
                    seedDatabaseMessage.className = 'text-center text-red-400 mt-4 h-5';
                }
                setTimeout(() => { seedDatabaseMessage.textContent = ''; }, 5000);
            });

            createCurriculumForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = newCurriculumNameInput.value.trim();
                if (!name) return;
                try {
                    const resp = await fetch('/api/admin/create-curriculum', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name })
                    });
                    const result = await resp.json();
                    createCurriculumMessage.textContent = result.message;
                    createCurriculumMessage.className = resp.ok ? 'text-center text-green-400 mt-4 h-5' : 'text-center text-red-400 mt-4 h-5';
                    if (resp.ok) {
                        createCurriculumForm.reset();
                        await loadCurriculums();
                        await initializeTopicData();
                        fetchAndDisplayCurriculums();
                        fetchCurriculumTable();
                    }
                } catch (error) {
                    createCurriculumMessage.textContent = 'Server connection error.';
                    createCurriculumMessage.className = 'text-center text-red-400 mt-4 h-5';
                }
                setTimeout(() => { createCurriculumMessage.textContent = ''; }, 5000);
            });


            // --- INIT ---
            usersTabBtn.addEventListener('click', () => {
                usersSection.classList.remove('hidden');
                questionsSection.classList.add('hidden');
                storiesSection.classList.add('hidden');
                flagsSection.classList.add('hidden');
                attemptsSection.classList.add('hidden'); // NEW
                curriculumsSection.classList.add('hidden');
                usersTabBtn.classList.add('active');
                questionsTabBtn.classList.remove('active');
                storiesTabBtn.classList.remove('active');
                flagsTabBtn.classList.remove('active');
                attemptsTabBtn.classList.remove('active'); // NEW
                curriculumsTabBtn.classList.remove('active');
            });
            questionsTabBtn.addEventListener('click', () => {
                usersSection.classList.add('hidden');
                questionsSection.classList.remove('hidden');
                storiesSection.classList.add('hidden');
                flagsSection.classList.add('hidden');
                attemptsSection.classList.add('hidden'); // NEW
                curriculumsSection.classList.add('hidden');
                usersTabBtn.classList.remove('active');
                questionsTabBtn.classList.add('active');
                storiesTabBtn.classList.remove('active');
                flagsTabBtn.classList.remove('active');
                attemptsTabBtn.classList.remove('active'); // NEW
                curriculumsTabBtn.classList.remove('active');
                fetchAndDisplayQuestions();
            });
            storiesTabBtn.addEventListener('click', () => {
                usersSection.classList.add('hidden');
                questionsSection.classList.add('hidden');
                storiesSection.classList.remove('hidden');
                flagsSection.classList.add('hidden');
                attemptsSection.classList.add('hidden'); // NEW
                curriculumsSection.classList.add('hidden');
                usersTabBtn.classList.remove('active');
                questionsTabBtn.classList.remove('active');
                storiesTabBtn.classList.add('active');
                flagsTabBtn.classList.remove('active');
                attemptsTabBtn.classList.remove('active'); // NEW
                curriculumsTabBtn.classList.remove('active');
                fetchAndDisplayStories();
            });
            flagsTabBtn.addEventListener('click', () => {
                usersSection.classList.add('hidden');
                questionsSection.classList.add('hidden');
                storiesSection.classList.add('hidden');
                flagsSection.classList.remove('hidden');
                attemptsSection.classList.add('hidden'); // NEW
                curriculumsSection.classList.add('hidden');
                usersTabBtn.classList.remove('active');
                questionsTabBtn.classList.remove('active');
                storiesTabBtn.classList.remove('active');
                flagsTabBtn.classList.add('active');
                attemptsTabBtn.classList.remove('active'); // NEW
                curriculumsTabBtn.classList.remove('active');
                fetchAndDisplayFlaggedItems();
            });
            // NEW: Event listener for Attempts tab
            attemptsTabBtn.addEventListener('click', () => {
                usersSection.classList.add('hidden');
                questionsSection.classList.add('hidden');
                storiesSection.classList.add('hidden');
                flagsSection.classList.add('hidden');
                attemptsSection.classList.remove('hidden'); // NEW
                curriculumsSection.classList.add('hidden');
                usersTabBtn.classList.remove('active');
                questionsTabBtn.classList.remove('active');
                storiesTabBtn.classList.remove('active');
                flagsTabBtn.classList.remove('active');
                attemptsTabBtn.classList.add('active'); // NEW
                curriculumsTabBtn.classList.remove('active');
                fetchAndDisplayQuestionAttempts(); // Fetch attempts when tab is clicked
            });
            curriculumsTabBtn.addEventListener('click', () => {
                usersSection.classList.add('hidden');
                questionsSection.classList.add('hidden');
                storiesSection.classList.add('hidden');
                flagsSection.classList.add('hidden');
                attemptsSection.classList.add('hidden');
                curriculumsSection.classList.remove('hidden');
                usersTabBtn.classList.remove('active');
                questionsTabBtn.classList.remove('active');
                storiesTabBtn.classList.remove('active');
                flagsTabBtn.classList.remove('active');
                attemptsTabBtn.classList.remove('active');
                curriculumsTabBtn.classList.add('active');
                fetchAndDisplayCurriculums();
                fetchCurriculumTable();
            });


            userTableBody.addEventListener('click', (event) => { const target = event.target; if (target.classList.contains('delete-user-btn')) handleDeleteUser(target.dataset.userid, target.dataset.username); if (target.classList.contains('edit-user-btn')) handleOpenEditModal(target.dataset.userid); });
            addAnswerBtn.addEventListener('click', () => addAnswerInput(answersContainer)); // Pass container
            addStepBtn.addEventListener('click', () => addStepInput(stepsContainer)); // Pass container
            addSectionBtn.addEventListener('click', addSectionToBuilder);

            if (questionFilterInput) {
                questionFilterInput.addEventListener('input', applyQuestionFilter);
            }
            if (questionFilterColumn) {
                questionFilterColumn.addEventListener('change', applyQuestionFilter);
            }
            if (storyFilterInput) {
                storyFilterInput.addEventListener('input', applyStoryFilter);
            }
            if (storyFilterColumn) {
                storyFilterColumn.addEventListener('change', applyStoryFilter);
            }
            if (flagFilterInput) {
                flagFilterInput.addEventListener('input', applyFlagFilter);
            }
            if (flagFilterColumn) {
                flagFilterColumn.addEventListener('change', applyFlagFilter);
            }
            if (attemptFilterInput) {
                attemptFilterInput.addEventListener('input', applyAttemptFilter);
            }
            if (attemptFilterColumn) {
                attemptFilterColumn.addEventListener('change', applyAttemptFilter);
            }

            document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', () => {
                hideModal(editUserModal);
                hideModal(editQuestionModal);
                hideModal(editCurriculumModal);
            }));

            document.getElementById('signOutButton').addEventListener('click', () => { localStorage.clear(); window.location.href = '/'; });
            if (signOutButtonMobile) {
                signOutButtonMobile.addEventListener('click', () => {
                    localStorage.clear();
                    window.location.href = '/';
                });
            }

            const POLL_INTERVAL_MS = 5000; // poll every 5 seconds
            setInterval(() => {
                if (document.hidden) return; // don't poll when tab not visible
                if (usersTabBtn.classList.contains('active') && window.refreshUsers) {
                    window.refreshUsers();
                }
                if (questionsTabBtn.classList.contains('active')) {
                    fetchAndDisplayQuestions();
                }
                if (storiesTabBtn.classList.contains('active')) {
                    fetchAndDisplayStories();
                }
                if (flagsTabBtn.classList.contains('active')) {
                    fetchAndDisplayFlaggedItems();
                }
                if (attemptsTabBtn.classList.contains('active')) {
                    fetchAndDisplayQuestionAttempts();
                }
                if (curriculumsTabBtn.classList.contains('active')) {
                    fetchAndDisplayCurriculums();
                    fetchCurriculumTable();
                }
            }, POLL_INTERVAL_MS);

            const initializeApp = async () => {
                if (window.refreshUsers) window.refreshUsers();
                await loadCurriculums();
                await initializeTopicData();
                fetchAndDisplayCurriculums();
                fetchCurriculumTable();
                addAnswerInput(answersContainer, true, '', true); // Pass container
                addAnswerInput(answersContainer, false, '', false); // Pass container
                addStepInput(stepsContainer, '', true); // Pass container
                document.querySelector('input[name="question-type"][value="MultipleChoice"]').checked = true;
                document.querySelector('input[name="question-type"][value="MultipleChoice"]').dispatchEvent(new Event('change')); // Trigger change to initialize required fields
                difficultyRatingSelect.value = '3';
            };
            initializeApp();
        });
    </script>
    <div id="flag-modal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center opacity-0">
        <div class="modal-content bg-slate-800 rounded-2xl p-8 max-w-md w-full mx-4 relative scale-95">
            <button id="close-flag-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <h2 class="text-2xl font-bold text-white mb-4">Report Issue</h2>
            <textarea id="flag-reason" class="w-full h-32 bg-slate-700 text-gray-200 p-2 rounded-md mb-4" placeholder="Describe the issue (optional)"></textarea>
            <button id="submit-flag-btn" class="bg-yellow-400 text-slate-900 font-bold py-2 px-6 rounded-full hover:bg-yellow-300 w-full">Submit</button>
        </div>
    </div>

    <script src="/static/js/userTable.js"></script>
    <!-- Back to Top button -->
    <button id="backToTop" aria-label="Back to top"
      class="hidden fixed bottom-20 right-4 px-4 py-2 rounded-full bg-yellow-400 text-black shadow-lg transition-opacity duration-300">
      ↑ Top
    </button>
    <script src="/static/js/flagModal.js"></script>
    <script src="/static/js/flagErrorButton.js"></script>
    <script src="/static/js/backToTop.js"></script>
</body>
</html>
